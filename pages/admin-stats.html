<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống Kê - Admin</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <a href="../index.html"> NTT Express </a>
          </div>

          <nav class="nav">
            <ul class="nav-list">
              <li>
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
              </li>
              <li>
                <a href="admin-orders.html" class="nav-link"
                  >Quản Lý Đơn Hàng</a
                >
              </li>
              <li>
                <a href="admin-users.html" class="nav-link"
                  >Quản Lý Người Dùng</a
                >
              </li>
              <li>
                <a href="admin-stats.html" class="nav-link active">Thống Kê</a>
              </li>
              <li>
                <a href="admin-settings.html" class="nav-link">Cài Đặt</a>
              </li>
            </ul>
          </nav>

          <div class="header-actions">
            <div class="user-menu">
              <span class="user-name" id="userName">Admin</span>
              <button class="btn btn-secondary" onclick="logout()">
                Đăng Xuất
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Page Header -->
        <div class="page-header">
          <h1>Thống Kê & Báo Cáo</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportStats()">
              <i data-lucide="download"></i>
              Xuất Báo Cáo
            </button>
          </div>
        </div>

        <!-- Date Filters -->
        <div class="filters-section">
          <div class="filters-grid">
            <div class="filter-group">
              <label for="dateFromFilter">Từ Ngày</label>
              <input type="date" id="dateFromFilter" class="form-input" />
            </div>
            <div class="filter-group">
              <label for="dateToFilter">Đến Ngày</label>
              <input type="date" id="dateToFilter" class="form-input" />
            </div>
            <div class="filter-group">
              <button class="btn btn-primary" onclick="loadStats()">
                <i data-lucide="refresh-cw"></i>
                Cập Nhật
              </button>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
          <div class="chart-container">
            <h3>Thống Kê Theo Trạng Thái</h3>
            <canvas id="statusChart"></canvas>
          </div>

          <div class="chart-container">
            <h3>Thống Kê Theo Thời Gian</h3>
            <canvas id="timeChart"></canvas>
          </div>
        </div>

        <!-- Overview Stats -->
        <div class="overview-stats">
          <h3>Tổng Quan</h3>
          <div class="stats-grid" id="statsGrid">
            <!-- Stats will be loaded here -->
          </div>
        </div>

        <!-- Detailed Stats -->
        <div class="detailed-stats">
          <div class="stats-tabs">
            <button class="tab-btn active" onclick="showTab('status')">
              Theo Trạng Thái
            </button>
            <button class="tab-btn" onclick="showTab('time')">
              Theo Thời Gian
            </button>
            <button class="tab-btn" onclick="showTab('customer')">
              Theo Khách Hàng
            </button>
            <button class="tab-btn" onclick="showTab('staff')">
              Theo Nhân Viên
            </button>
            <button class="tab-btn" onclick="showTab('performance')">
              Hiệu Suất Giao Hàng
            </button>
          </div>

          <div class="tab-content" id="statusTab">
            <div class="table-container">
              <table class="table" id="statusTable">
                <thead>
                  <tr>
                    <th>Trạng Thái</th>
                    <th>Số Lượng</th>
                    <th>Tổng Doanh Thu</th>
                    <th>Doanh Thu Trung Bình</th>
                    <th>Đơn Hàng Đầu Tiên</th>
                    <th>Đơn Hàng Cuối</th>
                  </tr>
                </thead>
                <tbody id="statusTableBody">
                  <tr>
                    <td colspan="6" class="text-center">Đang tải...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-content" id="timeTab" style="display: none">
            <div class="table-container">
              <table class="table" id="timeTable">
                <thead>
                  <tr>
                    <th>Thời Gian</th>
                    <th>Tổng Đơn Hàng</th>
                    <th>Chờ Xử Lý</th>
                    <th>Đang Xử Lý</th>
                    <th>Đang Giao</th>
                    <th>Đã Giao</th>
                    <th>Thất Bại</th>
                    <th>Doanh Thu</th>
                  </tr>
                </thead>
                <tbody id="timeTableBody">
                  <tr>
                    <td colspan="8" class="text-center">Đang tải...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-content" id="customerTab" style="display: none">
            <div class="table-container">
              <table class="table" id="customerTable">
                <thead>
                  <tr>
                    <th>Khách Hàng</th>
                    <th>Tổng Đơn Hàng</th>
                    <th>Đã Giao</th>
                    <th>Thất Bại</th>
                    <th>Tổng Doanh Thu</th>
                    <th>Doanh Thu TB</th>
                    <th>Đơn Hàng Đầu</th>
                    <th>Đơn Hàng Cuối</th>
                  </tr>
                </thead>
                <tbody id="customerTableBody">
                  <tr>
                    <td colspan="8" class="text-center">Đang tải...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-content" id="staffTab" style="display: none">
            <div class="table-container">
              <table class="table" id="staffTable">
                <thead>
                  <tr>
                    <th>Nhân Viên</th>
                    <th>Tổng Đơn Hàng</th>
                    <th>Đã Giao</th>
                    <th>Thất Bại</th>
                    <th>Tổng Doanh Thu</th>
                    <th>Doanh Thu TB</th>
                    <th>Đơn Hàng Đầu</th>
                    <th>Đơn Hàng Cuối</th>
                  </tr>
                </thead>
                <tbody id="staffTableBody">
                  <tr>
                    <td colspan="8" class="text-center">Đang tải...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-content" id="performanceTab" style="display: none">
            <div class="performance-stats">
              <div class="performance-card">
                <h4>Thời Gian Giao Hàng Trung Bình</h4>
                <div class="performance-value" id="avgDeliveryTime">-</div>
              </div>
              <div class="performance-card">
                <h4>Tỷ Lệ Giao Hàng Đúng Hạn</h4>
                <div class="performance-value" id="onTimeDeliveryRate">-</div>
              </div>
              <div class="performance-card">
                <h4>Đơn Hàng Giao Thành Công</h4>
                <div class="performance-value" id="deliveredOrders">-</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="../js/lucide.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/script.js"></script>
    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Check authentication
      auth.redirectIfNotAdmin();

      // Load user info
      const user = JSON.parse(localStorage.getItem("user") || "{}");
      document.getElementById("userName").textContent =
        user.full_name || "Admin";

      // Charts
      let statusChart, timeChart;

      // Load all statistics
      async function loadStats() {
        try {
          const dateFrom = document.getElementById("dateFromFilter").value;
          const dateTo = document.getElementById("dateToFilter").value;
          const params = {};

          if (dateFrom) params.start_date = dateFrom;
          if (dateTo) params.end_date = dateTo;

          console.log("Loading stats with params:", params);

          // Load daily stats from statistics table
          const dailyResponse = await api.getDailyStats(params);
          console.log("Daily response:", dailyResponse);
          if (dailyResponse.success) {
            displayDailyStats(dailyResponse.data);
            updateDailyChart(dailyResponse.data.statistics);
          } else {
            console.error("Daily stats failed:", dailyResponse);
            // Show specific error message
            if (dailyResponse.message) {
              ui.showError(
                "Lỗi tải dữ liệu thống kê: " + dailyResponse.message
              );
            } else {
              ui.showError("Không thể tải dữ liệu thống kê");
            }
            displayDailyStats({ totals: {} });
          }

          // Load status stats
          const statusResponse = await api.getStatusStats(params);
          console.log("Status response:", statusResponse);
          if (statusResponse.success) {
            displayStatusStats(statusResponse.data);
            updateStatusChart(statusResponse.data);
          } else {
            console.error("Status stats failed:", statusResponse);
            displayStatusStats([]);
          }

          // Load customer stats
          const customerResponse = await api.getCustomerStats(params);
          if (customerResponse.success) {
            displayCustomerStats(customerResponse.data);
          } else {
            displayCustomerStats([]);
          }

          // Load staff stats
          const staffResponse = await api.getStaffStats(params);
          if (staffResponse.success) {
            console.log("Staff stats response:", staffResponse.data);
            displayStaffStats(staffResponse.data);
          } else {
            console.log("Staff stats failed:", staffResponse);
            displayStaffStats([]);
          }

          // Load performance stats
          const performanceResponse = await api.getDeliveryPerformance(params);
          if (performanceResponse.success) {
            displayPerformanceStats(performanceResponse.data);
          } else {
            displayPerformanceStats({});
          }
        } catch (error) {
          console.error("Error loading stats:", error);
          // Show error only if it's a network error, not just empty data
          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("NetworkError")
          ) {
            ui.showError(
              "Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng."
            );
          } else {
            ui.showError("Không thể tải dữ liệu thống kê: " + error.message);
          }
          // Display empty data when error occurs
          displayDailyStats({ totals: {} });
        }
      }

      function displayDailyStats(data) {
        const statsGrid = document.getElementById("statsGrid");
        if (!statsGrid) {
          console.error("statsGrid element not found");
          return;
        }
        const totals = data.totals || {};

        console.log("Daily stats data:", data); // Debug log
        console.log("Totals:", totals); // Debug log

        // Ensure all values are numbers, not NaN
        const totalOrders = parseInt(totals.total_orders) || 0;
        const totalRevenue = parseFloat(totals.total_revenue) || 0;
        const deliveredOrders = parseInt(totals.delivered_orders) || 0;
        const pendingOrders = parseInt(totals.pending_orders) || 0;

        // Check if we have valid data
        if (!data || Object.keys(totals).length === 0) {
          statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Tổng Đơn Hàng</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">₫0</div>
                            <div class="stat-label">Tổng Doanh Thu</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Đã Giao</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Chờ Xử Lý</div>
                        </div>
                    </div>
                `;
        } else {
          statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">${totalOrders}</div>
                            <div class="stat-label">Tổng Đơn Hàng</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">${ui.formatCurrency(
                              totalRevenue
                            )}</div>
                            <div class="stat-label">Tổng Doanh Thu</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">${deliveredOrders}</div>
                            <div class="stat-label">Đã Giao</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">${pendingOrders}</div>
                            <div class="stat-label">Chờ Xử Lý</div>
                        </div>
                    </div>
                `;
        }

        // Re-initialize Lucide icons after updating HTML
        lucide.createIcons();
      }

      function displayStatusStats(stats) {
        try {
          const tbody = document.getElementById("statusTableBody");

          if (!tbody) {
            console.error("Status table body not found");
            return;
          }

          console.log("Displaying status stats:", stats);

          // Handle different data formats
          let statsArray = [];

          if (Array.isArray(stats)) {
            statsArray = stats;
          } else if (stats && typeof stats === "object") {
            // If stats is an object, try to extract array from common properties
            if (stats.data && Array.isArray(stats.data)) {
              statsArray = stats.data;
            } else if (stats.statuses && Array.isArray(stats.statuses)) {
              statsArray = stats.statuses;
            } else if (stats.results && Array.isArray(stats.results)) {
              statsArray = stats.results;
            } else {
              // If it's a single object, wrap it in an array
              statsArray = [stats];
            }
          } else {
            console.warn("Invalid status stats data format:", stats);
            statsArray = [];
          }

          if (statsArray.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="text-center">Không có dữ liệu</td></tr>';
            return;
          }

          tbody.innerHTML = statsArray
            .map((stat) => {
              try {
                return `
                     <tr>
                         <td>${getStatusText(
                           stat.current_status || stat.status
                         )}</td>
                         <td>${stat.count || 0}</td>
                         <td>${ui.formatCurrency(stat.total_revenue || 0)}</td>
                         <td>${ui.formatCurrency(stat.avg_revenue || 0)}</td>
                         <td>${
                           stat.first_order
                             ? ui.formatDateTime(stat.first_order)
                             : "-"
                         }</td>
                         <td>${
                           stat.last_order
                             ? ui.formatDateTime(stat.last_order)
                             : "-"
                         }</td>
                     </tr>
                 `;
              } catch (error) {
                console.error("Error rendering status stat row:", error, stat);
                return '<tr><td colspan="6" class="text-center text-danger">Lỗi hiển thị dữ liệu</td></tr>';
              }
            })
            .join("");
        } catch (error) {
          console.error("Error in displayStatusStats:", error);
          const tbody = document.getElementById("statusTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
          }
        }
      }

      function displayTimeStats(stats) {
        try {
          const tbody = document.getElementById("timeTableBody");

          if (!tbody) {
            console.error("Time table body not found");
            return;
          }

          console.log("Displaying time stats:", stats);

          // Handle different data formats
          let statsArray = [];

          if (Array.isArray(stats)) {
            statsArray = stats;
          } else if (stats && typeof stats === "object") {
            // If stats is an object, try to extract array from common properties
            if (stats.data && Array.isArray(stats.data)) {
              statsArray = stats.data;
            } else if (stats.statistics && Array.isArray(stats.statistics)) {
              statsArray = stats.statistics;
            } else if (stats.results && Array.isArray(stats.results)) {
              statsArray = stats.results;
            } else {
              // If it's a single object, wrap it in an array
              statsArray = [stats];
            }
          } else {
            console.warn("Invalid time stats data format:", stats);
            statsArray = [];
          }

          if (statsArray.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>';
            return;
          }

          tbody.innerHTML = statsArray
            .map((stat) => {
              try {
                return `
                    <tr>
                        <td>${ui.formatDate(stat.period || stat.date)}</td>
                        <td>${stat.total_orders || 0}</td>
                        <td>${stat.pending_orders || 0}</td>
                        <td>${stat.processing_orders || 0}</td>
                        <td>${stat.shipping_orders || 0}</td>
                        <td>${stat.delivered_orders || 0}</td>
                        <td>${stat.failed_orders || 0}</td>
                        <td>${ui.formatCurrency(stat.total_revenue || 0)}</td>
                    </tr>
                `;
              } catch (error) {
                console.error("Error rendering time stat row:", error, stat);
                return '<tr><td colspan="8" class="text-center text-danger">Lỗi hiển thị dữ liệu</td></tr>';
              }
            })
            .join("");
        } catch (error) {
          console.error("Error in displayTimeStats:", error);
          const tbody = document.getElementById("timeTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
          }
        }
      }

      function displayCustomerStats(stats) {
        try {
          const tbody = document.getElementById("customerTableBody");

          if (!tbody) {
            console.error("Customer table body not found");
            return;
          }

          console.log("Displaying customer stats:", stats);

          // Handle different data formats
          let statsArray = [];

          if (Array.isArray(stats)) {
            statsArray = stats;
          } else if (stats && typeof stats === "object") {
            // If stats is an object, try to extract array from common properties
            if (stats.data && Array.isArray(stats.data)) {
              statsArray = stats.data;
            } else if (stats.customers && Array.isArray(stats.customers)) {
              statsArray = stats.customers;
            } else if (stats.results && Array.isArray(stats.results)) {
              statsArray = stats.results;
            } else {
              // If it's a single object, wrap it in an array
              statsArray = [stats];
            }
          } else {
            console.warn("Invalid customer stats data format:", stats);
            statsArray = [];
          }

          if (statsArray.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>';
            return;
          }

          tbody.innerHTML = statsArray
            .map((stat) => {
              try {
                return `
                     <tr>
                         <td>${
                           stat.customer_name ||
                           stat.name ||
                           stat.full_name ||
                           "-"
                         }</td>
                         <td>${stat.total_orders || 0}</td>
                         <td>${stat.delivered_orders || 0}</td>
                         <td>${stat.failed_orders || 0}</td>
                         <td>${ui.formatCurrency(stat.total_revenue || 0)}</td>
                         <td>${ui.formatCurrency(stat.avg_revenue || 0)}</td>
                         <td>${
                           stat.first_order
                             ? ui.formatDateTime(stat.first_order)
                             : "-"
                         }</td>
                         <td>${
                           stat.last_order
                             ? ui.formatDateTime(stat.last_order)
                             : "-"
                         }</td>
                     </tr>
                 `;
              } catch (error) {
                console.error(
                  "Error rendering customer stat row:",
                  error,
                  stat
                );
                return '<tr><td colspan="8" class="text-center text-danger">Lỗi hiển thị dữ liệu</td></tr>';
              }
            })
            .join("");
        } catch (error) {
          console.error("Error in displayCustomerStats:", error);
          const tbody = document.getElementById("customerTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
          }
        }
      }

      function displayStaffStats(stats) {
        try {
          const tbody = document.getElementById("staffTableBody");

          if (!tbody) {
            console.error("Staff table body not found");
            return;
          }

          console.log("Displaying staff stats:", stats);

          // Handle different data formats
          let statsArray = [];

          if (Array.isArray(stats)) {
            statsArray = stats;
          } else if (stats && typeof stats === "object") {
            // If stats is an object, try to extract array from common properties
            if (stats.data && Array.isArray(stats.data)) {
              statsArray = stats.data;
            } else if (stats.staff && Array.isArray(stats.staff)) {
              statsArray = stats.staff;
            } else if (stats.results && Array.isArray(stats.results)) {
              statsArray = stats.results;
            } else {
              // If it's a single object, wrap it in an array
              statsArray = [stats];
            }
          } else {
            console.warn("Invalid stats data format:", stats);
            statsArray = [];
          }

          if (statsArray.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>';
            return;
          }

          tbody.innerHTML = statsArray
            .map((stat) => {
              try {
                return `
                            <tr>
                                <td>${
                                  stat.staff_name ||
                                  stat.name ||
                                  stat.full_name ||
                                  "-"
                                }</td>
                                <td>${stat.total_orders || 0}</td>
                                <td>${stat.delivered_orders || 0}</td>
                                <td>${stat.failed_orders || 0}</td>
                                <td>${ui.formatCurrency(
                                  stat.total_revenue || 0
                                )}</td>
                                <td>${ui.formatCurrency(
                                  stat.avg_revenue || 0
                                )}</td>
                                <td>${
                                  stat.first_order
                                    ? ui.formatDateTime(stat.first_order)
                                    : "-"
                                }</td>
                                <td>${
                                  stat.last_order
                                    ? ui.formatDateTime(stat.last_order)
                                    : "-"
                                }</td>
                            </tr>
                        `;
              } catch (error) {
                console.error("Error rendering staff stat row:", error, stat);
                return '<tr><td colspan="8" class="text-center text-danger">Lỗi hiển thị dữ liệu</td></tr>';
              }
            })
            .join("");
        } catch (error) {
          console.error("Error in displayStaffStats:", error);
          const tbody = document.getElementById("staffTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
          }
        }
      }

      function displayPerformanceStats(data) {
        const deliveryTime = data.delivery_time;
        const onTimeDelivery = data.on_time_delivery;

        document.getElementById("avgDeliveryTime").textContent =
          deliveryTime.avg_delivery_hours
            ? `${Math.round(deliveryTime.avg_delivery_hours)} giờ`
            : "-";

        document.getElementById("onTimeDeliveryRate").textContent =
          onTimeDelivery.on_time_deliveries
            ? `${Math.round(
                (onTimeDelivery.on_time_count /
                  onTimeDelivery.on_time_deliveries) *
                  100
              )}%`
            : "-";

        document.getElementById("deliveredOrders").textContent =
          deliveryTime.total_delivered || 0;
      }

      function updateStatusChart(data) {
        try {
          const canvas = document.getElementById("statusChart");
          if (!canvas) {
            console.error("Status chart canvas not found");
            return;
          }

          const ctx = canvas.getContext("2d");

          if (statusChart) {
            statusChart.destroy();
          }

          // Ensure data is an array
          let chartData = [];
          if (Array.isArray(data)) {
            chartData = data;
          } else if (data && Array.isArray(data.data)) {
            chartData = data.data;
          } else if (data && Array.isArray(data.statuses)) {
            chartData = data.statuses;
          }

          if (chartData.length === 0) {
            console.warn("No data available for status chart");
            return;
          }

          statusChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: chartData.map((item) =>
                getStatusText(item.current_status || item.status)
              ),
              datasets: [
                {
                  data: chartData.map((item) => item.count || 0),
                  backgroundColor: [
                    "#FF6384",
                    "#36A2EB",
                    "#FFCE56",
                    "#4BC0C0",
                    "#9966FF",
                    "#FF9F40",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
            },
          });
        } catch (error) {
          console.error("Error updating status chart:", error);
        }
      }

      function updateTimeChart(data) {
        try {
          const canvas = document.getElementById("timeChart");
          if (!canvas) {
            console.error("Time chart canvas not found");
            return;
          }

          const ctx = canvas.getContext("2d");

          if (timeChart) {
            timeChart.destroy();
          }

          // Ensure data is an array
          let chartData = [];
          if (Array.isArray(data)) {
            chartData = data;
          } else if (data && Array.isArray(data.data)) {
            chartData = data.data;
          } else if (data && Array.isArray(data.statistics)) {
            chartData = data.statistics;
          }

          if (chartData.length === 0) {
            console.warn("No data available for time chart");
            return;
          }

          timeChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: chartData.map((item) =>
                ui.formatDate(item.period || item.date)
              ),
              datasets: [
                {
                  label: "Tổng Đơn Hàng",
                  data: chartData.map((item) => item.total_orders || 0),
                  borderColor: "#36A2EB",
                  backgroundColor: "rgba(54, 162, 235, 0.1)",
                  tension: 0.1,
                },
                {
                  label: "Đã Giao",
                  data: chartData.map((item) => item.delivered_orders || 0),
                  borderColor: "#4BC0C0",
                  backgroundColor: "rgba(75, 192, 192, 0.1)",
                  tension: 0.1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        } catch (error) {
          console.error("Error updating time chart:", error);
        }
      }

      function updateDailyChart(statistics) {
        try {
          const canvas = document.getElementById("timeChart");
          if (!canvas) {
            console.error("Time chart canvas not found");
            return;
          }

          const ctx = canvas.getContext("2d");

          if (timeChart) {
            timeChart.destroy();
          }

          // Ensure statistics is an array
          let chartData = [];
          if (Array.isArray(statistics)) {
            chartData = statistics;
          } else if (statistics && Array.isArray(statistics.data)) {
            chartData = statistics.data;
          } else if (statistics && Array.isArray(statistics.statistics)) {
            chartData = statistics.statistics;
          }

          if (chartData.length === 0) {
            console.warn("No data available for daily chart");
            return;
          }

          const labels = chartData.map((stat) =>
            ui.formatDate(stat.date || stat.period)
          );
          const datasets = [
            {
              label: "Tổng đơn hàng",
              data: chartData.map((stat) => stat.total_orders || 0),
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              tension: 0.4,
            },
            {
              label: "Đã giao",
              data: chartData.map((stat) => stat.delivered_orders || 0),
              borderColor: "#10b981",
              backgroundColor: "rgba(16, 185, 129, 0.1)",
              tension: 0.4,
            },
          ];

          timeChart = new Chart(ctx, {
            type: "line",
            data: { labels, datasets },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" },
                title: { display: true, text: "Thống kê theo ngày" },
              },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });
        } catch (error) {
          console.error("Error updating daily chart:", error);
        }
      }

      function getStatusText(status) {
        const textMap = {
          pending: "Chờ xử lý",
          processing: "Đang xử lý",
          shipping: "Đang giao",
          delivered: "Đã giao",
          failed: "Thất bại",
          cancelled: "Đã hủy",
        };
        return textMap[status] || status;
      }

      function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.style.display = "none";
        });

        // Remove active class from all buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName + "Tab").style.display = "block";

        // Add active class to clicked button
        event.target.classList.add("active");
      }

      async function exportStats() {
        try {
          const dateFrom = document.getElementById("dateFromFilter").value;
          const dateTo = document.getElementById("dateToFilter").value;
          const params = { type: "orders" };

          if (dateFrom) params.start_date = dateFrom;
          if (dateTo) params.end_date = dateTo;

          // Tạo URL với params
          const queryString = new URLSearchParams(params).toString();
          const url = `${api.baseURL}/stats/export?${queryString}`;

          // Tạo download link
          const a = document.createElement("a");
          a.href = url;
          a.download = `orders_${dateFrom || "all"}_${dateTo || "all"}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          ui.showSuccess("Xuất báo cáo thành công!");
        } catch (error) {
          console.error("Export error:", error);
          ui.showError("Có lỗi xảy ra khi xuất báo cáo");
        }
      }

      async function testStats() {
        try {
          console.log("Testing stats endpoint...");
          const response = await api.testStats();
          console.log("Test response:", response);

          if (response.success) {
            ui.showSuccess(
              `Test thành công! Statistics: ${response.data.statistics_count}, Orders: ${response.data.orders_count}`
            );
          } else {
            ui.showError("Test thất bại: " + response.message);
          }
        } catch (error) {
          console.error("Test error:", error);
          ui.showError("Test lỗi: " + error.message);
        }
      }

      function logout() {
        api.logout();
      }

      // Load data immediately
      loadStats();
    </script>
  </body>
</html>
