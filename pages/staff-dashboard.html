<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - NTT Express</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/stats.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                        NTT Express
                    </a>
                </div>
                
                <nav class="nav">
                    <ul class="nav-list">
                        <li><a href="staff-dashboard.html" class="nav-link active">Dashboard</a></li>
                        <li><a href="staff-orders.html" class="nav-link">Qu·∫£n L√Ω ƒê∆°n H√†ng</a></li>
                        <li><a href="staff-track.html" class="nav-link">Theo D√µi Giao H√†ng</a></li>
                        <li><a href="staff-stats.html" class="nav-link">Th·ªëng K√™</a></li>
                    </ul>
                </nav>
                
                <div class="header-actions">
                    <div class="user-menu">
                        <span class="user-name" id="userName">Staff</span>
                        <button class="btn btn-secondary" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Staff Dashboard</h1>
                <p>Qu·∫£n l√Ω ƒë∆°n h√†ng v√† giao h√†ng</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Thao T√°c Nhanh</h2>
                <div class="actions-grid">
                    <a href="staff-orders.html" class="action-card">
                        <i data-lucide="plus"></i>
                        <span>T·∫°o ƒê∆°n H√†ng M·ªõi</span>
                    </a>
                    <a href="staff-track.html" class="action-card">
                        <i data-lucide="map-pin"></i>
                        <span>Theo D√µi Giao H√†ng</span>
                    </a>
                    <a href="staff-stats.html" class="action-card">
                        <i data-lucide="bar-chart-3"></i>
                        <span>Xem Th·ªëng K√™</span>
                    </a>
                    <a href="staff-settings.html" class="action-card">
                        <i data-lucide="settings"></i>
                        <span>C√†i ƒê·∫∑t</span>
                    </a>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="recent-orders">
                <div class="section-header">
                    <h2>ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h2>
                    <a href="staff-orders.html" class="btn btn-secondary">Xem T·∫•t C·∫£</a>
                </div>
                <div class="table-container">
                    <table class="table" id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>M√£ ƒê∆°n</th>
                                <th>Ng∆∞·ªùi G·ª≠i</th>
                                <th>Ng∆∞·ªùi Nh·∫≠n</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>Ng√†y T·∫°o</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody">
                            <tr>
                                <td colspan="6" class="text-center">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Today's Tasks -->
            <div class="today-tasks">
                <h2>C√¥ng Vi·ªác H√¥m Nay</h2>
                <div class="tasks-grid" id="tasksGrid">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <script src="../js/lucide.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/script.js"></script>
    <script src="../js/role-navigation.js"></script>
    <script src="../js/stats-loader.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Check authentication
        auth.redirectIfNotStaff();

        // Load user info
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = user.full_name || 'Staff';

        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log('üîÑ Loading staff dashboard data...');
                
                // Show loading state
                showStatsLoading(true);
                
                // Load daily stats from statistics table
                const statsResponse = await api.getDailyStats();
                console.log('üìä Stats response:', statsResponse);
                
                if (statsResponse.success && statsResponse.data && statsResponse.data.totals) {
                    const totals = statsResponse.data.totals;
                    console.log('üìà Totals:', totals);
                    
                    // Ensure all values are numbers, not NaN
                    const totalOrders = parseInt(totals.total_orders) || 0;
                    const pendingOrders = parseInt(totals.pending_orders) || 0;
                    const shippingOrders = parseInt(totals.shipping_orders) || 0;
                    const deliveredOrders = parseInt(totals.delivered_orders) || 0;
                    
                    // Update stats with proper loading state handling
                    updateStatValue('totalOrders', totalOrders);
                    updateStatValue('pendingOrders', pendingOrders);
                    updateStatValue('shippingOrders', shippingOrders);
                    updateStatValue('deliveredOrders', deliveredOrders);
                    
                    console.log('‚úÖ Stats updated successfully');
                } else {
                    console.error('‚ùå Stats API failed or no data:', statsResponse);
                    // Set default values if API fails
                    updateStatValue('totalOrders', 0);
                    updateStatValue('pendingOrders', 0);
                    updateStatValue('shippingOrders', 0);
                    updateStatValue('deliveredOrders', 0);
                }

                // Load recent orders
                const ordersResponse = await api.getOrders({ limit: 5 });
                if (ordersResponse.success) {
                    displayRecentOrders(ordersResponse.data.orders);
                }

            } catch (error) {
                console.error('‚ùå Staff dashboard load error:', error);
                ui.showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu dashboard');
                
                // Set default values on error
                updateStatValue('totalOrders', 0);
                updateStatValue('pendingOrders', 0);
                updateStatValue('shippingOrders', 0);
                updateStatValue('deliveredOrders', 0);
            } finally {
                // Hide loading state
                showStatsLoading(false);
            }
        }
        
        function showStatsLoading(show) {
            const spinnerIds = ['totalOrdersSpinner', 'pendingOrdersSpinner', 'shippingOrdersSpinner', 'deliveredOrdersSpinner'];
            const valueIds = ['totalOrders', 'pendingOrders', 'shippingOrders', 'deliveredOrders'];
            
            spinnerIds.forEach((spinnerId, index) => {
                const spinner = document.getElementById(spinnerId);
                const valueElement = document.getElementById(valueIds[index]);
                const statValue = valueElement.querySelector('.stat-value');
                
                if (show) {
                    spinner.style.display = 'inline';
                    statValue.style.display = 'none';
                } else {
                    spinner.style.display = 'none';
                    statValue.style.display = 'inline';
                }
            });
        }
        
        function updateStatValue(elementId, value) {
            const element = document.getElementById(elementId);
            const statValue = element.querySelector('.stat-value');
            const spinner = element.querySelector('.loading-spinner');
            
            statValue.textContent = value;
            statValue.style.display = 'inline';
            spinner.style.display = 'none';
        }

        function displayRecentOrders(orders) {
            const tbody = document.getElementById('recentOrdersBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><strong>${order.order_code}</strong></td>
                    <td>${order.sender_name}</td>
                    <td>${order.receiver_name}</td>
                    <td>${ui.getStatusBadge(order.current_status)}</td>
                    <td>${ui.formatDateTime(order.created_at)}</td>
                    <td>
                        <a href="staff-order-detail.html?id=${order.id}" class="btn btn-sm btn-primary">Xem</a>
                        <a href="staff-order-edit.html?id=${order.id}" class="btn btn-sm btn-secondary">S·ª≠a</a>
                    </td>
                </tr>
            `).join('');
        }

        async function loadTodayTasks() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const ordersResponse = await api.getOrders({ 
                    start_date: today, 
                    end_date: today,
                    limit: 10 
                });

                if (ordersResponse.success) {
                    displayTodayTasks(ordersResponse.data.orders);
                }
            } catch (error) {
                console.error('Error loading today tasks:', error);
            }
        }

        function displayTodayTasks(orders) {
            const tasksGrid = document.getElementById('tasksGrid');
            
            if (orders.length === 0) {
                tasksGrid.innerHTML = '<div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o cho h√¥m nay</div>';
                return;
            }

            tasksGrid.innerHTML = orders.map(order => `
                <div class="task-card ${order.current_status}">
                    <div class="task-header">
                        <h4>${order.order_code}</h4>
                        <span class="task-status">${getStatusText(order.current_status)}</span>
                    </div>
                    <div class="task-content">
                        <p><strong>G·ª≠i:</strong> ${order.sender_name}</p>
                        <p><strong>Nh·∫≠n:</strong> ${order.receiver_name}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.receiver_address}</p>
                    </div>
                    <div class="task-actions">
                        <a href="staff-order-detail.html?id=${order.id}" class="btn btn-sm btn-primary">Xem Chi Ti·∫øt</a>
                        <button class="btn btn-sm btn-secondary" onclick="updateOrderStatus(${order.id})">C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i</button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const textMap = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'shipping': 'ƒêang giao',
                'delivered': 'ƒê√£ giao',
                'failed': 'Th·∫•t b·∫°i',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return textMap[status] || status;
        }

        async function updateOrderStatus(orderId) {
            const status = prompt('Nh·∫≠p tr·∫°ng th√°i m·ªõi (pending/processing/shipping/delivered/failed/cancelled):');
            if (!status) return;

            const description = prompt('Nh·∫≠p m√¥ t·∫£:');
            if (!description) return;

            const location = prompt('Nh·∫≠p v·ªã tr√≠ hi·ªán t·∫°i (t√πy ch·ªçn):');

            try {
                const response = await api.updateOrderStatus(orderId, status, description, location);
                
                if (response.success) {
                    ui.showSuccess('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    loadDashboardData();
                } else {
                    ui.showError(response.message || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i');
                }
            } catch (error) {
                ui.showError(error.message || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
            }
        }

        function logout() {
            api.logout();
        }

        // Load dashboard data immediately when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Staff dashboard page loaded, starting data load...');
            loadDashboardData();
            loadTodayTasks();
        });
        
        // Also try to load data immediately if DOM is already ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                loadDashboardData();
                loadTodayTasks();
            });
        } else {
            // DOM is already ready, load immediately
            console.log('‚ö° DOM already ready, loading staff dashboard data immediately...');
            loadDashboardData();
            loadTodayTasks();
        }
    </script>
</body>
</html> 