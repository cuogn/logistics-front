<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đơn Hàng Mới - Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/maps.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- HERE Maps CSS -->
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <!-- HERE Maps JavaScript -->
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <style>
        .distance-calculator {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .main-content {
            padding: 2rem 0;
        }
        .form-section {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-input, .form-select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-error {
            color: #dc2626;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        .form-error.show {
            display: block;
        }
        .input-error {
            border-color: #dc2626 !important;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-outline {
            background: transparent;
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }
        .btn-outline:hover {
            background: #3b82f6;
            color: white;
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }
        .distance-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .distance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .distance-title {
            font-weight: 600;
            color: #0c4a6e;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .distance-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .distance-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e0f2fe;
        }
        .distance-label {
            font-size: 12px;
            color: #0369a1;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .distance-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0c4a6e;
        }
        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
            border: 2px solid #e5e7eb;
        }
        .map-controls {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        .map-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 14px;
            color: #0c4a6e;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        @media (max-width: 768px) {
            .form-section, .distance-calculator {
                padding: 10px;
            }
            .form-row, .distance-details {
                grid-template-columns: 1fr;
            }
            .map-controls {
                flex-direction: column;
            }
            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">NTT Express</a>
                </div>
                <nav class="nav">
                    <ul class="nav-list">
                        <li><a href="admin-dashboard.html" class="nav-link">Dashboard</a></li>
                        <li><a href="admin-orders.html" class="nav-link">Quản Lý Đơn Hàng</a></li>
                        <li><a href="admin-users.html" class="nav-link">Quản Lý Người Dùng</a></li>
                        <li><a href="admin-stats.html" class="nav-link">Thống Kê</a></li>
                        <li><a href="admin-settings.html" class="nav-link">Cài Đặt</a></li>
                    </ul>
                </nav>
                <div class="header-actions">
                    <div class="user-menu">
                        <span class="user-name" id="userName">Admin</span>
                        <button class="btn btn-secondary" onclick="logout()">Đăng Xuất</button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="main-content">
        <div class="distance-calculator">
            <div class="page-header">
                <h2><i data-lucide="route"></i> Tạo Đơn Hàng Mới (Chọn Điểm A/B trên bản đồ)</h2>
                <p>Chọn hai điểm trên bản đồ để lấy địa chỉ, tính khoảng cách và phí vận chuyển. Sau đó điền thông tin hàng hóa bên dưới.</p>
            </div>
            <div class="map-controls">
                <button type="button" class="btn btn-primary" onclick="setPointA()"><i data-lucide="map-pin"></i> Đặt Điểm A</button>
                <button type="button" class="btn btn-primary" onclick="setPointB()"><i data-lucide="map-pin"></i> Đặt Điểm B</button>
                <button type="button" class="btn btn-success" onclick="calculateDistance()"><i data-lucide="calculator"></i> Tính Khoảng Cách</button>
                <button type="button" class="btn btn-outline" onclick="clearMap()"><i data-lucide="x"></i> Xóa</button>
            </div>
            <div id="map" class="map-container"></div>
            <div class="map-status" id="mapStatus"><i data-lucide="info"></i> Nhấp vào bản đồ để đặt điểm A (bắt đầu)</div>
            <div class="distance-section">
                <div class="distance-header">
                    <h3 class="distance-title"><i data-lucide="route"></i> Kết Quả</h3>
                </div>
                <div class="distance-details" id="distanceDetails" style="display: none;">
                    <div class="distance-item">
                        <div class="distance-label">Khoảng Cách</div>
                        <div class="distance-value" id="distanceText">-</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">Thời Gian Dự Kiến</div>
                        <div class="distance-value" id="durationText">-</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">Phí Vận Chuyển</div>
                        <div class="distance-value" id="calculatedFee">-</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">Phí Theo Kg</div>
                        <div class="distance-value" id="weightFee">-</div>
                    </div>
                </div>
            </div>
            <!-- Form thông tin hàng hóa -->
            <form id="createOrderForm" class="form-section">
                <h2 class="section-title"><i data-lucide="package"></i> Thông Tin Hàng Hóa</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="packageWeight" class="form-label">Trọng Lượng (kg) *</label>
                        <input type="number" id="packageWeight" name="package_weight" class="form-input" step="0.1" min="0.1" required>
                        <div class="form-error" id="packageWeightError">Trọng lượng phải là số dương</div>
                    </div>
                    <div class="form-group">
                        <label for="shippingFee" class="form-label">Phí Vận Chuyển (VNĐ) *</label>
                        <input type="number" id="shippingFee" name="shipping_fee" class="form-input" min="0" required disabled>
                        <div class="form-error" id="shippingFeeError">Phí vận chuyển phải là số dương</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="packageDimensions" class="form-label">Kích Thước</label>
                    <input type="text" id="packageDimensions" name="package_dimensions" class="form-input" placeholder="Dài x Rộng x Cao (cm)">
                </div>
                <div class="form-group">
                    <label for="packageDescription" class="form-label">Mô Tả Hàng Hóa</label>
                    <textarea id="packageDescription" name="package_description" class="form-input" rows="3" placeholder="Mô tả chi tiết về hàng hóa..."></textarea>
                </div>
                <div class="form-group">
                    <label for="estimatedDeliveryDate" class="form-label">Ngày Giao Dự Kiến</label>
                    <input type="date" id="estimatedDeliveryDate" name="estimated_delivery_date" class="form-input">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" id="submitOrderBtn">
                        <span class="btn-text"><i data-lucide="check"></i> Tạo Đơn Hàng</span>
                        <span class="btn-loading" style="display: none;"><i data-lucide="loader-2" class="animate-spin"></i> Đang tạo...</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
    <script src="../js/lucide.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/distance-calculator.js"></script>
    <script>
        lucide.createIcons();
        // Check authentication
        auth.redirectIfNotAdmin();
        // Load user info
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = user.full_name || 'Admin';
        // Map logic sẽ lấy từ distance-calculator.js
        // Override displayDistanceInfo để cập nhật phí vận chuyển vào input
        let distanceCalculator = null;
        let calculatedFee = null;
        document.addEventListener('DOMContentLoaded', () => {
            distanceCalculator = new DistanceCalculator();
            if (distanceCalculator && distanceCalculator.displayDistanceInfo) {
                distanceCalculator.displayDistanceInfo = function(route) {
                    if (route && route.distance) {
                        document.getElementById('distanceText').textContent = this.formatDistance(route.distance);
                        document.getElementById('durationText').textContent = this.formatDuration(route.duration);
                        calculatedFee = this.calculatePrice(route.distance);
                        document.getElementById('calculatedFee').textContent = formatCurrency(calculatedFee);
                        const weight = parseFloat(document.getElementById('packageWeight').value) || 0;
                        const weightFee = weight * 1000;
                        document.getElementById('weightFee').textContent = formatCurrency(weightFee);
                        document.getElementById('shippingFee').value = calculatedFee;
                        document.getElementById('distanceDetails').style.display = 'grid';
                    }
                };
            }
        });
        // Form submit
        document.getElementById('createOrderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // Validate trọng lượng
            const weight = parseFloat(document.getElementById('packageWeight').value);
            if (isNaN(weight) || weight <= 0) {
                document.getElementById('packageWeightError').classList.add('show');
                return;
            } else {
                document.getElementById('packageWeightError').classList.remove('show');
            }
            // Validate đã có phí vận chuyển
            if (!calculatedFee) {
                document.getElementById('shippingFeeError').classList.add('show');
                return;
            } else {
                document.getElementById('shippingFeeError').classList.remove('show');
            }
            // Lấy thông tin điểm A/B từ distanceCalculator
            const senderAddress = distanceCalculator.point1Address || '';
            const receiverAddress = distanceCalculator.point2Address || '';
            // Lấy lat/lng nếu có
            const senderLat = distanceCalculator.point1 ? distanceCalculator.point1.lat : null;
            const senderLng = distanceCalculator.point1 ? distanceCalculator.point1.lng : null;
            const receiverLat = distanceCalculator.point2 ? distanceCalculator.point2.lat : null;
            const receiverLng = distanceCalculator.point2 ? distanceCalculator.point2.lng : null;
            // Lấy các trường còn lại
            const formData = new FormData(e.target);
            const orderData = Object.fromEntries(formData.entries());
            orderData.sender_address = senderAddress;
            orderData.receiver_address = receiverAddress;
            orderData.sender_lat = senderLat;
            orderData.sender_lng = senderLng;
            orderData.receiver_lat = receiverLat;
            orderData.receiver_lng = receiverLng;
            orderData.shipping_fee = calculatedFee;
            try {
                const response = await api.createOrder(orderData);
                if (response.success) {
                    alert('Tạo đơn hàng thành công!');
                    window.location.href = 'admin-orders.html';
                } else {
                    alert(response.message || 'Tạo đơn hàng thất bại');
                }
            } catch (error) {
                alert(error.message || 'Có lỗi xảy ra khi tạo đơn hàng');
            }
        });
        function logout() { api.logout(); }
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
    </script>
</body>
</html> 