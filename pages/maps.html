<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản Đồ Logistics - LogiTrack</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/maps.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- HERE Maps CSS -->
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <!-- HERE Maps JavaScript -->
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1><i class="fas fa-truck"></i> LogiTrack</h1>
                </div>
                <nav class="nav">
                    <ul>
                        <li><a href="dashboard.html"><i class="fas fa-home"></i> Trang chủ</a></li>
                        <li><a href="orders.html"><i class="fas fa-box"></i> Đơn hàng</a></li>
                        <li><a href="vehicles.html"><i class="fas fa-truck"></i> Phương tiện</a></li>
                        <li><a href="maps.html" class="active"><i class="fas fa-map"></i> Bản đồ</a></li>
                        <li><a href="stats.html"><i class="fas fa-chart-bar"></i> Thống kê</a></li>
                        <li><a href="settings.html"><i class="fas fa-cog"></i> Cài đặt</a></li>
                        <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h2><i class="fas fa-map-marked-alt"></i> Bản Đồ Logistics</h2>
                <p>Quản lý tuyến đường và điều phối phương tiện</p>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <label for="orderSelect">Chọn đơn hàng:</label>
                    <select id="orderSelect" class="form-control">
                        <option value="">-- Chọn đơn hàng --</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="vehicleSelect">Chọn phương tiện:</label>
                    <select id="vehicleSelect" class="form-control">
                        <option value="">-- Chọn phương tiện --</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="showRouteBtn" class="btn btn-primary">
                        <i class="fas fa-route"></i> Hiển thị tuyến đường
                    </button>
                    <button id="optimizeBtn" class="btn btn-success">
                        <i class="fas fa-magic"></i> Tối ưu hóa
                    </button>
                    <button id="clearMapBtn" class="btn btn-secondary">
                        <i class="fas fa-eraser"></i> Xóa bản đồ
                    </button>
                    <button id="testGeocodingBtn" class="btn btn-info">
                        <i class="fas fa-search"></i> Test Geocoding
                    </button>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="map" class="map"></div>
                
                <!-- Route Info Panel -->
                <div class="route-info-panel" id="routeInfoPanel">
                    <div class="panel-header">
                        <h3><i class="fas fa-info-circle"></i> Thông tin tuyến đường</h3>
                        <button class="close-btn" id="closeRouteInfo">&times;</button>
                    </div>
                    <div class="panel-content">
                        <div class="info-item">
                            <span class="label">Khoảng cách:</span>
                            <span class="value" id="routeDistance">--</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Thời gian:</span>
                            <span class="value" id="routeDuration">--</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Tình trạng giao thông:</span>
                            <span class="value" id="trafficStatus">--</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Thời gian giao dự kiến:</span>
                            <span class="value" id="estimatedDelivery">--</span>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Assignment Panel -->
                <div class="assignment-panel" id="assignmentPanel">
                    <div class="panel-header">
                        <h3><i class="fas fa-truck"></i> Điều phối phương tiện</h3>
                        <button class="close-btn" id="closeAssignment">&times;</button>
                    </div>
                    <div class="panel-content">
                        <div class="assignment-list" id="assignmentList">
                            <!-- Assignment items will be added here -->
                        </div>
                        <div class="assignment-actions">
                            <button id="applyAssignmentsBtn" class="btn btn-primary">
                                <i class="fas fa-check"></i> Áp dụng
                            </button>
                            <button id="cancelAssignmentsBtn" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order List -->
            <div class="orders-section">
                <h3><i class="fas fa-list"></i> Danh sách đơn hàng</h3>
                <div class="orders-grid" id="ordersGrid">
                    <!-- Orders will be loaded here -->
                </div>
            </div>

            <!-- Vehicle List -->
            <div class="vehicles-section">
                <h3><i class="fas fa-truck"></i> Phương tiện khả dụng</h3>
                <div class="vehicles-grid" id="vehiclesGrid">
                    <!-- Vehicles will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p>Đang tải dữ liệu...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // HERE Maps Integration - Đơn giản
        class SimpleMapsManager {
            constructor() {
                this.map = null;
                this.platform = null;
                this.markers = [];
                this.selectedOrders = [];
                this.selectedVehicles = [];
                this.orders = [];
                this.vehicles = [];
                this.currentRoute = null;
                
                this.init();
            }

            async init() {
                try {
                    // Kiểm tra authentication
                    if (!checkAuth()) {
                        window.location.href = 'login.html';
                        return;
                    }

                    // Khởi tạo HERE Maps
                    this.initMap();
                    
                    // Load dữ liệu
                    await this.loadOrders();
                    await this.loadVehicles();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.error('Error initializing maps:', error);
                    showNotification('Lỗi khởi tạo bản đồ', 'error');
                }
            }

            initMap() {
                try {
                    // HERE Maps API Key
                    const apiKey = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
                    
                    // Khởi tạo platform
                    this.platform = new H.service.Platform({
                        apikey: apiKey
                    });

                    // Tạo default layers
                    const defaultLayers = this.platform.createDefaultLayers();

                    // Khởi tạo map
                    this.map = new H.Map(document.getElementById('map'), 
                        defaultLayers.vector.normal.map, {
                        center: { lat: 21.0285, lng: 105.8542 }, // Hà Nội
                        zoom: 10,
                        pixelRatio: window.devicePixelRatio || 1
                    });

                    // Thêm resize listener
                    window.addEventListener('resize', () => this.map.getViewPort().resize());

                    // Tạo behavior cho map
                    const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(this.map));

                    // Tạo UI
                    const ui = H.ui.UI.createDefault(this.map, defaultLayers);

                    showNotification('✅ Bản đồ đã được khởi tạo thành công!', 'success');

                } catch (error) {
                    console.error('Error initializing map:', error);
                    showNotification('Lỗi khởi tạo bản đồ', 'error');
                }
            }

            async loadOrders() {
                try {
                    showLoading();
                    const response = await apiCall('GET', '/api/orders?limit=50');
                    
                    if (response.success) {
                        this.orders = response.data.orders;
                        this.renderOrdersGrid();
                        this.populateOrderSelect();
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    showNotification('Lỗi tải danh sách đơn hàng', 'error');
                } finally {
                    hideLoading();
                }
            }

            async loadVehicles() {
                try {
                    showLoading();
                    const response = await apiCall('GET', '/api/vehicles?available=true');
                    
                    if (response.success) {
                        this.vehicles = response.data.vehicles;
                        this.renderVehiclesGrid();
                        this.populateVehicleSelect();
                    }
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                    showNotification('Lỗi tải danh sách phương tiện', 'error');
                } finally {
                    hideLoading();
                }
            }

            renderOrdersGrid() {
                const grid = document.getElementById('ordersGrid');
                grid.innerHTML = '';

                this.orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.dataset.orderId = order.id;
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${order.order_code}</div>
                            <div class="card-status status-${order.current_status}">${this.getStatusText(order.current_status)}</div>
                        </div>
                        <div class="card-details">
                            <div><strong>Người gửi:</strong> ${order.sender_name}</div>
                            <div><strong>Người nhận:</strong> ${order.receiver_name}</div>
                            <div><strong>Trọng lượng:</strong> ${order.package_weight} kg</div>
                            <div><strong>Phí vận chuyển:</strong> ${this.formatCurrency(order.shipping_fee)}</div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => this.toggleOrderSelection(order.id));
                    grid.appendChild(card);
                });
            }

            renderVehiclesGrid() {
                const grid = document.getElementById('vehiclesGrid');
                grid.innerHTML = '';

                this.vehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'vehicle-card';
                    card.dataset.vehicleId = vehicle.id;
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${vehicle.vehicle_code}</div>
                            <div class="card-status status-${vehicle.is_available ? 'available' : 'unavailable'}">
                                ${vehicle.is_available ? 'Khả dụng' : 'Không khả dụng'}
                            </div>
                        </div>
                        <div class="card-details">
                            <div><strong>Loại:</strong> ${this.getVehicleTypeText(vehicle.vehicle_type)}</div>
                            <div><strong>Tài xế:</strong> ${vehicle.driver_name}</div>
                            <div><strong>Sức chứa:</strong> ${vehicle.capacity} kg</div>
                            <div><strong>Vị trí:</strong> ${vehicle.current_location}</div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => this.toggleVehicleSelection(vehicle.id));
                    grid.appendChild(card);
                });
            }

            populateOrderSelect() {
                const select = document.getElementById('orderSelect');
                select.innerHTML = '<option value="">-- Chọn đơn hàng --</option>';
                
                this.orders.forEach(order => {
                    const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `${order.order_code} - ${order.sender_name} → ${order.receiver_name}`;
                    select.appendChild(option);
                });
            }

            populateVehicleSelect() {
                const select = document.getElementById('vehicleSelect');
                select.innerHTML = '<option value="">-- Chọn phương tiện --</option>';
                
                this.vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.vehicle_code} - ${vehicle.driver_name} (${this.getVehicleTypeText(vehicle.vehicle_type)})`;
                    select.appendChild(option);
                });
            }

            toggleOrderSelection(orderId) {
                const card = document.querySelector(`[data-order-id="${orderId}"]`);
                const index = this.selectedOrders.indexOf(orderId);
                
                if (index > -1) {
                    this.selectedOrders.splice(index, 1);
                    card.classList.remove('selected');
                } else {
                    this.selectedOrders.push(orderId);
                    card.classList.add('selected');
                }
            }

            toggleVehicleSelection(vehicleId) {
                const card = document.querySelector(`[data-vehicle-id="${vehicleId}"]`);
                const index = this.selectedVehicles.indexOf(vehicleId);
                
                if (index > -1) {
                    this.selectedVehicles.splice(index, 1);
                    card.classList.remove('selected');
                } else {
                    this.selectedVehicles.push(vehicleId);
                    card.classList.add('selected');
                }
            }

            async testGeocoding() {
                try {
                    showNotification('🔍 Đang test Geocoding API...', 'info');
                    
                    const response = await fetch(`https://revgeocode.search.hereapi.com/v1/revgeocode?at=21.0285,105.8542&apiKey=7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE`);
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        const address = data.items[0].address.label;
                        showNotification(`✅ Geocoding OK: ${address}`, 'success');
                    } else {
                        showNotification('❌ Không tìm thấy địa chỉ', 'error');
                    }
                    
                } catch (error) {
                    showNotification('❌ Lỗi Geocoding: ' + error.message, 'error');
                    console.error('Geocoding error:', error);
                }
            }

            clearMap() {
                if (this.currentRoute) {
                    this.map.removeObject(this.currentRoute);
                    this.currentRoute = null;
                }
                this.clearMarkers();
                
                // Ẩn các panel
                document.getElementById('routeInfoPanel').style.display = 'none';
                document.getElementById('assignmentPanel').style.display = 'none';
                
                // Bỏ chọn tất cả
                this.selectedOrders = [];
                this.selectedVehicles = [];
                document.querySelectorAll('.order-card.selected, .vehicle-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                
                showNotification('🗺️ Đã xóa bản đồ', 'success');
            }

            clearMarkers() {
                this.markers.forEach(marker => this.map.removeObject(marker));
                this.markers = [];
            }

            setupEventListeners() {
                // Test Geocoding button
                document.getElementById('testGeocodingBtn').addEventListener('click', () => {
                    this.testGeocoding();
                });

                // Clear map button
                document.getElementById('clearMapBtn').addEventListener('click', () => {
                    this.clearMap();
                });

                // Close panels
                document.getElementById('closeRouteInfo').addEventListener('click', () => {
                    document.getElementById('routeInfoPanel').style.display = 'none';
                });

                document.getElementById('closeAssignment').addEventListener('click', () => {
                    document.getElementById('assignmentPanel').style.display = 'none';
                });
            }

            // Utility functions
            getStatusText(status) {
                const statusMap = {
                    'pending': 'Chờ xử lý',
                    'processing': 'Đang xử lý',
                    'shipping': 'Đang giao',
                    'delivered': 'Đã giao',
                    'failed': 'Thất bại',
                    'cancelled': 'Đã hủy'
                };
                return statusMap[status] || status;
            }

            getVehicleTypeText(type) {
                const typeMap = {
                    'truck': 'Xe tải',
                    'car': 'Ô tô',
                    'motorcycle': 'Xe máy',
                    'bicycle': 'Xe đạp',
                    'van': 'Xe van'
                };
                return typeMap[type] || type;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount);
            }
        }

        // Utility functions
        function showLoading() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function hideLoading() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showNotification(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // Tạo notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.color = 'white';
            notification.style.fontWeight = 'bold';
            
            if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#ffc107';
                notification.style.color = '#333';
            } else {
                notification.style.backgroundColor = '#007bff';
            }
            
            document.body.appendChild(notification);
            
            // Tự động xóa sau 3 giây
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Kiểm tra authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            return !!token;
        }

        // API call function
        async function apiCall(method, endpoint, data = null) {
            try {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const config = {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : undefined
                };
                
                const response = await fetch(`http://localhost:3000${endpoint}`, config);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'API Error');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Initialize maps when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleMapsManager();
        });
    </script>
</body>
</html> 