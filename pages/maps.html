<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒê·ªì Logistics - LogiTrack</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/maps.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- HERE Maps CSS -->
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <!-- HERE Maps JavaScript -->
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1><i class="fas fa-truck"></i> LogiTrack</h1>
                </div>
                <nav class="nav">
                    <ul>
                        <li><a href="dashboard.html"><i class="fas fa-home"></i> Trang ch·ªß</a></li>
                        <li><a href="orders.html"><i class="fas fa-box"></i> ƒê∆°n h√†ng</a></li>
                        <li><a href="vehicles.html"><i class="fas fa-truck"></i> Ph∆∞∆°ng ti·ªán</a></li>
                        <li><a href="maps.html" class="active"><i class="fas fa-map"></i> B·∫£n ƒë·ªì</a></li>
                        <li><a href="stats.html"><i class="fas fa-chart-bar"></i> Th·ªëng k√™</a></li>
                        <li><a href="settings.html"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a></li>
                        <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h2><i class="fas fa-map-marked-alt"></i> B·∫£n ƒê·ªì Logistics</h2>
                <p>Qu·∫£n l√Ω tuy·∫øn ƒë∆∞·ªùng v√† ƒëi·ªÅu ph·ªëi ph∆∞∆°ng ti·ªán</p>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <label for="orderSelect">Ch·ªçn ƒë∆°n h√†ng:</label>
                    <select id="orderSelect" class="form-control">
                        <option value="">-- Ch·ªçn ƒë∆°n h√†ng --</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="vehicleSelect">Ch·ªçn ph∆∞∆°ng ti·ªán:</label>
                    <select id="vehicleSelect" class="form-control">
                        <option value="">-- Ch·ªçn ph∆∞∆°ng ti·ªán --</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="showRouteBtn" class="btn btn-primary">
                        <i class="fas fa-route"></i> Hi·ªÉn th·ªã tuy·∫øn ƒë∆∞·ªùng
                    </button>
                    <button id="optimizeBtn" class="btn btn-success">
                        <i class="fas fa-magic"></i> T·ªëi ∆∞u h√≥a
                    </button>
                    <button id="clearMapBtn" class="btn btn-secondary">
                        <i class="fas fa-eraser"></i> X√≥a b·∫£n ƒë·ªì
                    </button>
                    <button id="testGeocodingBtn" class="btn btn-info">
                        <i class="fas fa-search"></i> Test Geocoding
                    </button>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="map" class="map"></div>
                
                <!-- Route Info Panel -->
                <div class="route-info-panel" id="routeInfoPanel">
                    <div class="panel-header">
                        <h3><i class="fas fa-info-circle"></i> Th√¥ng tin tuy·∫øn ƒë∆∞·ªùng</h3>
                        <button class="close-btn" id="closeRouteInfo">&times;</button>
                    </div>
                    <div class="panel-content">
                        <div class="info-item">
                            <span class="label">Kho·∫£ng c√°ch:</span>
                            <span class="value" id="routeDistance">--</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Th·ªùi gian:</span>
                            <span class="value" id="routeDuration">--</span>
                        </div>
                        <div class="info-item">
                            <span class="label">T√¨nh tr·∫°ng giao th√¥ng:</span>
                            <span class="value" id="trafficStatus">--</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Th·ªùi gian giao d·ª± ki·∫øn:</span>
                            <span class="value" id="estimatedDelivery">--</span>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Assignment Panel -->
                <div class="assignment-panel" id="assignmentPanel">
                    <div class="panel-header">
                        <h3><i class="fas fa-truck"></i> ƒêi·ªÅu ph·ªëi ph∆∞∆°ng ti·ªán</h3>
                        <button class="close-btn" id="closeAssignment">&times;</button>
                    </div>
                    <div class="panel-content">
                        <div class="assignment-list" id="assignmentList">
                            <!-- Assignment items will be added here -->
                        </div>
                        <div class="assignment-actions">
                            <button id="applyAssignmentsBtn" class="btn btn-primary">
                                <i class="fas fa-check"></i> √Åp d·ª•ng
                            </button>
                            <button id="cancelAssignmentsBtn" class="btn btn-secondary">
                                <i class="fas fa-times"></i> H·ªßy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order List -->
            <div class="orders-section">
                <h3><i class="fas fa-list"></i> Danh s√°ch ƒë∆°n h√†ng</h3>
                <div class="orders-grid" id="ordersGrid">
                    <!-- Orders will be loaded here -->
                </div>
            </div>

            <!-- Vehicle List -->
            <div class="vehicles-section">
                <h3><i class="fas fa-truck"></i> Ph∆∞∆°ng ti·ªán kh·∫£ d·ª•ng</h3>
                <div class="vehicles-grid" id="vehiclesGrid">
                    <!-- Vehicles will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // HERE Maps Integration - ƒê∆°n gi·∫£n
        class SimpleMapsManager {
            constructor() {
                this.map = null;
                this.platform = null;
                this.markers = [];
                this.selectedOrders = [];
                this.selectedVehicles = [];
                this.orders = [];
                this.vehicles = [];
                this.currentRoute = null;
                
                this.init();
            }

            async init() {
                try {
                    // Ki·ªÉm tra authentication
                    if (!checkAuth()) {
                        window.location.href = 'login.html';
                        return;
                    }

                    // Kh·ªüi t·∫°o HERE Maps
                    this.initMap();
                    
                    // Load d·ªØ li·ªáu
                    await this.loadOrders();
                    await this.loadVehicles();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.error('Error initializing maps:', error);
                    showNotification('L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì', 'error');
                }
            }

            initMap() {
                try {
                    // HERE Maps API Key
                    const apiKey = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
                    
                    // Kh·ªüi t·∫°o platform
                    this.platform = new H.service.Platform({
                        apikey: apiKey
                    });

                    // T·∫°o default layers
                    const defaultLayers = this.platform.createDefaultLayers();

                    // Kh·ªüi t·∫°o map
                    this.map = new H.Map(document.getElementById('map'), 
                        defaultLayers.vector.normal.map, {
                        center: { lat: 21.0285, lng: 105.8542 }, // H√† N·ªôi
                        zoom: 10,
                        pixelRatio: window.devicePixelRatio || 1
                    });

                    // Th√™m resize listener
                    window.addEventListener('resize', () => this.map.getViewPort().resize());

                    // T·∫°o behavior cho map
                    const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(this.map));

                    // T·∫°o UI
                    const ui = H.ui.UI.createDefault(this.map, defaultLayers);

                    showNotification('‚úÖ B·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng!', 'success');

                } catch (error) {
                    console.error('Error initializing map:', error);
                    showNotification('L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì', 'error');
                }
            }

            async loadOrders() {
                try {
                    showLoading();
                    const response = await apiCall('GET', '/api/orders?limit=50');
                    
                    if (response.success) {
                        this.orders = response.data.orders;
                        this.renderOrdersGrid();
                        this.populateOrderSelect();
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    showNotification('L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng', 'error');
                } finally {
                    hideLoading();
                }
            }

            async loadVehicles() {
                try {
                    showLoading();
                    const response = await apiCall('GET', '/api/vehicles?available=true');
                    
                    if (response.success) {
                        this.vehicles = response.data.vehicles;
                        this.renderVehiclesGrid();
                        this.populateVehicleSelect();
                    }
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                    showNotification('L·ªói t·∫£i danh s√°ch ph∆∞∆°ng ti·ªán', 'error');
                } finally {
                    hideLoading();
                }
            }

            renderOrdersGrid() {
                const grid = document.getElementById('ordersGrid');
                grid.innerHTML = '';

                this.orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.dataset.orderId = order.id;
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${order.order_code}</div>
                            <div class="card-status status-${order.current_status}">${this.getStatusText(order.current_status)}</div>
                        </div>
                        <div class="card-details">
                            <div><strong>Ng∆∞·ªùi g·ª≠i:</strong> ${order.sender_name}</div>
                            <div><strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${order.receiver_name}</div>
                            <div><strong>Tr·ªçng l∆∞·ª£ng:</strong> ${order.package_weight} kg</div>
                            <div><strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong> ${this.formatCurrency(order.shipping_fee)}</div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => this.toggleOrderSelection(order.id));
                    grid.appendChild(card);
                });
            }

            renderVehiclesGrid() {
                const grid = document.getElementById('vehiclesGrid');
                grid.innerHTML = '';

                this.vehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'vehicle-card';
                    card.dataset.vehicleId = vehicle.id;
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${vehicle.vehicle_code}</div>
                            <div class="card-status status-${vehicle.is_available ? 'available' : 'unavailable'}">
                                ${vehicle.is_available ? 'Kh·∫£ d·ª•ng' : 'Kh√¥ng kh·∫£ d·ª•ng'}
                            </div>
                        </div>
                        <div class="card-details">
                            <div><strong>Lo·∫°i:</strong> ${this.getVehicleTypeText(vehicle.vehicle_type)}</div>
                            <div><strong>T√†i x·∫ø:</strong> ${vehicle.driver_name}</div>
                            <div><strong>S·ª©c ch·ª©a:</strong> ${vehicle.capacity} kg</div>
                            <div><strong>V·ªã tr√≠:</strong> ${vehicle.current_location}</div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => this.toggleVehicleSelection(vehicle.id));
                    grid.appendChild(card);
                });
            }

            populateOrderSelect() {
                const select = document.getElementById('orderSelect');
                select.innerHTML = '<option value="">-- Ch·ªçn ƒë∆°n h√†ng --</option>';
                
                this.orders.forEach(order => {
                    const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `${order.order_code} - ${order.sender_name} ‚Üí ${order.receiver_name}`;
                    select.appendChild(option);
                });
            }

            populateVehicleSelect() {
                const select = document.getElementById('vehicleSelect');
                select.innerHTML = '<option value="">-- Ch·ªçn ph∆∞∆°ng ti·ªán --</option>';
                
                this.vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.vehicle_code} - ${vehicle.driver_name} (${this.getVehicleTypeText(vehicle.vehicle_type)})`;
                    select.appendChild(option);
                });
            }

            toggleOrderSelection(orderId) {
                const card = document.querySelector(`[data-order-id="${orderId}"]`);
                const index = this.selectedOrders.indexOf(orderId);
                
                if (index > -1) {
                    this.selectedOrders.splice(index, 1);
                    card.classList.remove('selected');
                } else {
                    this.selectedOrders.push(orderId);
                    card.classList.add('selected');
                }
            }

            toggleVehicleSelection(vehicleId) {
                const card = document.querySelector(`[data-vehicle-id="${vehicleId}"]`);
                const index = this.selectedVehicles.indexOf(vehicleId);
                
                if (index > -1) {
                    this.selectedVehicles.splice(index, 1);
                    card.classList.remove('selected');
                } else {
                    this.selectedVehicles.push(vehicleId);
                    card.classList.add('selected');
                }
            }

            async testGeocoding() {
                try {
                    showNotification('üîç ƒêang test Geocoding API...', 'info');
                    
                    const response = await fetch(`https://revgeocode.search.hereapi.com/v1/revgeocode?at=21.0285,105.8542&apiKey=7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE`);
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        const address = data.items[0].address.label;
                        showNotification(`‚úÖ Geocoding OK: ${address}`, 'success');
                    } else {
                        showNotification('‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ', 'error');
                    }
                    
                } catch (error) {
                    showNotification('‚ùå L·ªói Geocoding: ' + error.message, 'error');
                    console.error('Geocoding error:', error);
                }
            }

            clearMap() {
                if (this.currentRoute) {
                    this.map.removeObject(this.currentRoute);
                    this.currentRoute = null;
                }
                this.clearMarkers();
                
                // ·∫®n c√°c panel
                document.getElementById('routeInfoPanel').style.display = 'none';
                document.getElementById('assignmentPanel').style.display = 'none';
                
                // B·ªè ch·ªçn t·∫•t c·∫£
                this.selectedOrders = [];
                this.selectedVehicles = [];
                document.querySelectorAll('.order-card.selected, .vehicle-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                
                showNotification('üó∫Ô∏è ƒê√£ x√≥a b·∫£n ƒë·ªì', 'success');
            }

            clearMarkers() {
                this.markers.forEach(marker => this.map.removeObject(marker));
                this.markers = [];
            }

            setupEventListeners() {
                // Test Geocoding button
                document.getElementById('testGeocodingBtn').addEventListener('click', () => {
                    this.testGeocoding();
                });

                // Clear map button
                document.getElementById('clearMapBtn').addEventListener('click', () => {
                    this.clearMap();
                });

                // Close panels
                document.getElementById('closeRouteInfo').addEventListener('click', () => {
                    document.getElementById('routeInfoPanel').style.display = 'none';
                });

                document.getElementById('closeAssignment').addEventListener('click', () => {
                    document.getElementById('assignmentPanel').style.display = 'none';
                });
            }

            // Utility functions
            getStatusText(status) {
                const statusMap = {
                    'pending': 'Ch·ªù x·ª≠ l√Ω',
                    'processing': 'ƒêang x·ª≠ l√Ω',
                    'shipping': 'ƒêang giao',
                    'delivered': 'ƒê√£ giao',
                    'failed': 'Th·∫•t b·∫°i',
                    'cancelled': 'ƒê√£ h·ªßy'
                };
                return statusMap[status] || status;
            }

            getVehicleTypeText(type) {
                const typeMap = {
                    'truck': 'Xe t·∫£i',
                    'car': '√î t√¥',
                    'motorcycle': 'Xe m√°y',
                    'bicycle': 'Xe ƒë·∫°p',
                    'van': 'Xe van'
                };
                return typeMap[type] || type;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount);
            }
        }

        // Utility functions
        function showLoading() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function hideLoading() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showNotification(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // T·∫°o notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.color = 'white';
            notification.style.fontWeight = 'bold';
            
            if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#ffc107';
                notification.style.color = '#333';
            } else {
                notification.style.backgroundColor = '#007bff';
            }
            
            document.body.appendChild(notification);
            
            // T·ª± ƒë·ªông x√≥a sau 3 gi√¢y
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Ki·ªÉm tra authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            return !!token;
        }

        // API call function
        async function apiCall(method, endpoint, data = null) {
            try {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const config = {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : undefined
                };
                
                const response = await fetch(`http://localhost:3000${endpoint}`, config);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'API Error');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Initialize maps when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleMapsManager();
        });
    </script>
</body>
</html> 