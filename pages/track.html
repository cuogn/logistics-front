<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Đơn Hàng</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        #map {
            width: 100%;
            height: 350px;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">NTT Express</a>
                </div>
                <nav class="nav">
                    <ul class="nav-list">
                        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                        <li><a href="track.html" class="nav-link active">Theo Dõi Đơn Hàng</a></li>
                        <li><a href="about.html" class="nav-link">Giới Thiệu</a></li>
                        <li><a href="contact.html" class="nav-link">Liên Hệ</a></li>
                    </ul>
                </nav>
                <div class="header-actions">
                    <div class="user-menu">
                        <span class="user-name" id="userName">Khách hàng</span>
                        <button class="btn btn-secondary" onclick="logout()">Đăng Xuất</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Theo Dõi Đơn Hàng</h1>
            </div>
            <form id="trackForm" class="track-form">
                <div class="form-row">
                    <div class="form-group" style="flex:2;">
                        <input type="text" id="orderCode" name="orderCode" class="form-input" placeholder="Nhập mã đơn hàng..." required>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <button type="submit" class="btn btn-primary btn-full">Tra cứu</button>
                    </div>
                </div>
            </form>

            <div id="orderDetail" style="margin-top:2rem;"></div>
            <div id="map"></div>
            <div class="tracking-section" style="display:none;">
                <h2>Lịch Sử Trạng Thái</h2>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Thời Gian</th>
                                <th>Trạng Thái</th>
                                <th>Vị Trí</th>
                                <th>Mô Tả</th>
                                <th>Người Thực Hiện</th>
                            </tr>
                        </thead>
                        <tbody id="trackingBody">
                            <tr><td colspan="5" class="text-center">Chưa có dữ liệu</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/lucide.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/script.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <script>
        lucide.createIcons();
        auth.redirectIfNotLoggedIn();
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = user.full_name || 'Khách hàng';

        let currentOrder = null;

        document.getElementById('trackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const orderCode = document.getElementById('orderCode').value.trim();
            if (!orderCode) return;
            await searchOrder(orderCode);
        });

        async function searchOrder(orderCode) {
            const detailDiv = document.getElementById('orderDetail');
            detailDiv.innerHTML = '<div class="loading">Đang tải...</div>';
            document.querySelector('.tracking-section').style.display = 'none';
            document.getElementById('map').innerHTML = '';
            try {
                const response = await api.searchOrder(orderCode);
                if (response.success) {
                    const { order, tracking } = response.data;
                    currentOrder = order;
                    detailDiv.innerHTML = `
                        <div class="order-detail-card">
                            <h2>Mã Đơn: <span>${order.order_code}</span></h2>
                            <div class="order-info-grid">
                                <div>
                                    <h3>Người Gửi</h3>
                                    <p><strong>${order.sender_name}</strong></p>
                                    <p>${order.sender_phone}</p>
                                    <p>${order.sender_address}</p>
                                </div>
                                <div>
                                    <h3>Người Nhận</h3>
                                    <p><strong>${order.receiver_name}</strong></p>
                                    <p>${order.receiver_phone}</p>
                                    <p>${order.receiver_address}</p>
                                </div>
                                <div>
                                    <h3>Thông Tin Đơn Hàng</h3>
                                    <p>Trạng thái: ${ui.getStatusBadge(order.current_status)}</p>
                                    <p>Khối lượng: ${order.package_weight} kg</p>
                                    <p>Kích thước: ${order.package_dimensions || '-'}</p>
                                    <p>Phí vận chuyển: ${ui.formatCurrency(order.shipping_fee)}</p>
                                    <p>Tổng tiền: ${ui.formatCurrency(order.total_amount)}</p>
                                    <p>Ngày tạo: ${ui.formatDateTime(order.created_at)}</p>
                                    <p>Ngày giao dự kiến: ${order.estimated_delivery_date ? ui.formatDate(order.estimated_delivery_date) : '-'}</p>
                                    <p>Ngày giao thực tế: ${order.actual_delivery_date ? ui.formatDateTime(order.actual_delivery_date) : '-'}</p>
                                </div>
                            </div>
                            <div class="order-desc">
                                <h3>Mô tả hàng hóa</h3>
                                <p>${order.package_description || '-'}</p>
                            </div>
                        </div>
                    `;
                    // Tracking
                    const trackingBody = document.getElementById('trackingBody');
                    if (tracking.length === 0) {
                        trackingBody.innerHTML = '<tr><td colspan="5" class="text-center">Không có lịch sử trạng thái</td></tr>';
                    } else {
                        trackingBody.innerHTML = tracking.map(item => `
                            <tr>
                                <td>${ui.formatDateTime(item.created_at)}</td>
                                <td>${ui.getStatusBadge(item.status)}</td>
                                <td>${item.location || '-'}</td>
                                <td>${item.description || '-'}</td>
                                <td>${item.created_by_name || '-'}</td>
                            </tr>
                        `).join('');
                    }
                    document.querySelector('.tracking-section').style.display = 'block';
                    // Vẽ tuyến đường từ tracking cũ nhất đến mới nhất
                    if (tracking.length > 0) {
                        const first = tracking[tracking.length - 1]; // cũ nhất
                        const last = tracking[0]; // mới nhất
                        getLatLng(first, order.sender_lat, order.sender_lng, order.sender_address, function(startLat, startLng) {
                            getLatLng(last, order.receiver_lat, order.receiver_lng, order.receiver_address, function(endLat, endLng) {
                                if (startLat && startLng && endLat && endLng) {
                                    showRouteOnMap(startLat, startLng, endLat, endLng);
                                } else {
                                    showMapAtLocation(endLat, endLng, last.location || order.receiver_address);
                                }
                            });
                        });
                    } else {
                        // Fallback: sender -> receiver
                        if (order.sender_lat && order.sender_lng && order.receiver_lat && order.receiver_lng) {
                            showRouteOnMap(order.sender_lat, order.sender_lng, order.receiver_lat, order.receiver_lng);
                        } else if (order.sender_lat && order.sender_lng && order.receiver_address) {
                            geocodeAndShowRoute(order.sender_lat, order.sender_lng, order.receiver_address);
                        }
                    }
                } else {
                    detailDiv.innerHTML = '<div class="alert alert-error">Không tìm thấy đơn hàng</div>';
                }
            } catch (error) {
                detailDiv.innerHTML = '<div class="alert alert-error">Có lỗi xảy ra khi tải dữ liệu</div>';
            }
        }

        // Hàm lấy lat/lng từ tracking item hoặc geocode location
        function getLatLng(item, fallbackLat, fallbackLng, fallbackAddress, callback) {
            if (item.lat && item.lng) {
                callback(item.lat, item.lng);
            } else if (item.location) {
                geocodeAddress(item.location, callback);
            } else if (fallbackLat && fallbackLng) {
                callback(fallbackLat, fallbackLng);
            } else if (fallbackAddress) {
                geocodeAddress(fallbackAddress, callback);
            } else {
                callback(null, null);
            }
        }

        // Geocode địa chỉ, trả về callback(lat, lng)
        function geocodeAddress(address, callback) {
            const API_KEY = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
            const url = `https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(address)}&apiKey=${API_KEY}`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.items && data.items.length > 0) {
                        const pos = data.items[0].position;
                        callback(pos.lat, pos.lng);
                    } else {
                        callback(null, null);
                    }
                })
                .catch(() => callback(null, null));
        }

        function showRouteOnMap(senderLat, senderLng, receiverLat, receiverLng, fallbackToMarker = false) {
            console.log('Vẽ map từ:', senderLat, senderLng, 'đến', receiverLat, receiverLng);
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            const API_KEY = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
            const platform = new H.service.Platform({ apikey: API_KEY });
            const defaultLayers = platform.createDefaultLayers();
            const map = new H.Map(mapDiv, defaultLayers.vector.normal.map, {
                center: { lat: Number(receiverLat), lng: Number(receiverLng) },
                zoom: 13,
                pixelRatio: window.devicePixelRatio || 1
            });
            window.addEventListener('resize', () => map.getViewPort().resize());
            const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
            const ui = H.ui.UI.createDefault(map, defaultLayers);
            if (
                isNaN(Number(senderLat)) || isNaN(Number(senderLng)) ||
                isNaN(Number(receiverLat)) || isNaN(Number(receiverLng))
            ) {
                showMapAtLocation(receiverLat, receiverLng);
                return;
            }
            const router = platform.getRoutingService();
            const routingParams = {
                mode: 'fastest;car',
                representation: 'display',
                waypoint0: `${senderLat},${senderLng}`,
                waypoint1: `${receiverLat},${receiverLng}`
            };
            router.calculateRoute(routingParams, function(result) {
                if (result.response && result.response.route) {
                    const route = result.response.route[0];
                    const routeShape = route.shape;
                    const linestring = new H.geo.LineString();
                    routeShape.forEach(function(point) {
                        const parts = point.split(',');
                        linestring.pushLatLngAlt(Number(parts[0]), Number(parts[1]));
                    });
                    const routeLine = new H.map.Polyline(linestring, {
                        style: { strokeColor: '#007bff', lineWidth: 5 }
                    });
                    map.addObject(routeLine);
                    // Marker điểm đầu
                    const startMarker = new H.map.Marker({ lat: Number(senderLat), lng: Number(senderLng) });
                    map.addObject(startMarker);
                    // Marker điểm cuối
                    const endMarker = new H.map.Marker({ lat: Number(receiverLat), lng: Number(receiverLng) });
                    map.addObject(endMarker);
                    map.getViewModel().setLookAtData({ bounds: routeLine.getBoundingBox() });
                    const summary = route.summary;
                    const distanceKm = (summary.distance / 1000).toFixed(2);
                    const durationMin = Math.round(summary.travelTime / 60);
                    let infoHtml = `<div class='here-route-info'>` +
                        `<b>Quãng đường:</b> ${distanceKm} km<br>` +
                        `<b>Thời gian dự kiến:</b> ${durationMin} phút` +
                        `</div>`;
                    mapDiv.insertAdjacentHTML('beforeend', infoHtml);
                } else {
                    console.log('Không tìm thấy tuyến đường:', result);
                    showMapAtLocation(receiverLat, receiverLng);
                    mapDiv.insertAdjacentHTML('beforeend', "<div class='alert alert-warning'>Không tìm thấy tuyến đường, chỉ hiển thị điểm đích</div>");
                }
            }, function(error) {
                console.log('Lỗi HERE Routing API:', error);
                showMapAtLocation(receiverLat, receiverLng);
                mapDiv.insertAdjacentHTML('beforeend', "<div class='alert alert-error'>Lỗi tính toán tuyến đường, chỉ hiển thị điểm đích</div>");
            });
        }

        function showMapAtLocation(lat, lng, address = null) {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            const API_KEY = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
            const platform = new H.service.Platform({ apikey: API_KEY });
            const defaultLayers = platform.createDefaultLayers();
            let center = { lat: 16.05, lng: 108.2 };
            if (!isNaN(Number(lat)) && !isNaN(Number(lng))) {
                center = { lat: Number(lat), lng: Number(lng) };
            }
            const map = new H.Map(mapDiv, defaultLayers.vector.normal.map, {
                center: center,
                zoom: 14,
                pixelRatio: window.devicePixelRatio || 1
            });
            window.addEventListener('resize', () => map.getViewPort().resize());
            const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
            const ui = H.ui.UI.createDefault(map, defaultLayers);
            // Thêm marker nếu có tọa độ
            if (!isNaN(Number(center.lat)) && !isNaN(Number(center.lng))) {
                const marker = new H.map.Marker(center);
                map.addObject(marker);
            }
            if (address) {
                mapDiv.insertAdjacentHTML('beforeend', `<div class='here-route-info'>${address}</div>`);
            }
        }

        function logout() { api.logout(); }
    </script>
</body>
</html> 