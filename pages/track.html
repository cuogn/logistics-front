<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Đơn Hàng</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        #map {
            width: 100%;
            height: 350px;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">NTT Express</a>
                </div>
                <nav class="nav">
                    <ul class="nav-list">
                        <li><a href="customer-dashboard.html" class="nav-link">Dashboard</a></li>
                        <li><a href="track.html" class="nav-link active">Theo Dõi Đơn Hàng</a></li>
                        <li><a href="about.html" class="nav-link">Giới Thiệu</a></li>
                        <li><a href="contact.html" class="nav-link">Liên Hệ</a></li>
                    </ul>
                </nav>
                <div class="header-actions">
                    <div class="user-menu">
                        <span class="user-name" id="userName">Khách hàng</span>
                        <button class="btn btn-secondary" onclick="logout()">Đăng Xuất</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Theo Dõi Đơn Hàng</h1>
            </div>
            <form id="trackForm" class="track-form">
                <div class="form-row">
                    <div class="form-group" style="flex:2;">
                        <input type="text" id="orderCode" name="orderCode" class="form-input" placeholder="Nhập mã đơn hàng..." required>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <button type="submit" class="btn btn-primary btn-full">Tra cứu</button>
                    </div>
                </div>
            </form>

            <div id="orderDetail" style="margin-top:2rem;"></div>
            <div id="map"></div>
        </div>
    </main>

    <!-- Tracking History Section -->
    <div class="tracking-section" style="display:none; margin-top:2rem;">
        <div class="container">
            <h2>Lịch Sử Trạng Thái</h2>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Thời Gian</th>
                            <th>Trạng Thái</th>
                            <th>Vị Trí</th>
                            <th>Mô Tả</th>
                            <th>Người Thực Hiện</th>
                        </tr>
                    </thead>
                    <tbody id="trackingBody">
                        <tr><td colspan="5" class="text-center">Chưa có dữ liệu</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="../js/lucide.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/script.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <script>
        lucide.createIcons();
        auth.redirectIfNotLoggedIn();
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = user.full_name || 'Khách hàng';

        let currentOrder = null;

        document.getElementById('trackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const orderCode = document.getElementById('orderCode').value.trim();
            if (!orderCode) return;
            await searchOrder(orderCode);
        });

        async function searchOrder(orderCode) {
            const detailDiv = document.getElementById('orderDetail');
            detailDiv.innerHTML = '<div class="loading">Đang tải...</div>';
            document.querySelector('.tracking-section').style.display = 'none';
            document.getElementById('map').innerHTML = '';
            try {
                const response = await api.searchOrder(orderCode);
                if (response.success) {
                    const { order, tracking } = response.data;
                    currentOrder = order;
                    detailDiv.innerHTML = `
                        <div class="order-detail-card">
                            <h2>Mã Đơn: <span>${order.order_code}</span></h2>
                            <div class="order-info-grid">
                                <div>
                                    <h3>Người Gửi</h3>
                                    <p><strong>${order.sender_name}</strong></p>
                                    <p>${order.sender_phone}</p>
                                    <p>${order.sender_address}</p>
                                </div>
                                <div>
                                    <h3>Người Nhận</h3>
                                    <p><strong>${order.receiver_name}</strong></p>
                                    <p>${order.receiver_phone}</p>
                                    <p>${order.receiver_address}</p>
                                </div>
                                <div>
                                    <h3>Thông Tin Đơn Hàng</h3>
                                    <p>Trạng thái: ${ui.getStatusBadge(order.current_status)}</p>
                                    <p>Khối lượng: ${order.package_weight} kg</p>
                                    <p>Kích thước: ${order.package_dimensions || '-'}</p>
                                    <p>Phí vận chuyển: ${ui.formatCurrency(order.shipping_fee)}</p>
                                    <p>Tổng tiền: ${ui.formatCurrency(order.total_amount)}</p>
                                    <p>Ngày tạo: ${ui.formatDateTime(order.created_at)}</p>
                                    <p>Ngày giao dự kiến: ${order.estimated_delivery_date ? ui.formatDate(order.estimated_delivery_date) : '-'}</p>
                                    <p>Ngày giao thực tế: ${order.actual_delivery_date ? ui.formatDateTime(order.actual_delivery_date) : '-'}</p>
                                </div>
                            </div>
                            <div class="order-desc">
                                <h3>Mô tả hàng hóa</h3>
                                <p>${order.package_description || '-'}</p>
                            </div>
                        </div>
                    `;
                    // Tracking
                    const trackingBody = document.getElementById('trackingBody');
                    if (tracking.length === 0) {
                        trackingBody.innerHTML = '<tr><td colspan="5" class="text-center">Không có lịch sử trạng thái</td></tr>';
                    } else {
                        trackingBody.innerHTML = tracking.map(item => `
                            <tr>
                                <td>${ui.formatDateTime(item.created_at)}</td>
                                <td>${ui.getStatusBadge(item.status)}</td>
                                <td>${item.location || getCurrentPositionText(item.status)}</td>
                                <td>${item.description || '-'}</td>
                                <td>${item.created_by_name || '-'}</td>
                            </tr>
                        `).join('');
                    }
                    document.querySelector('.tracking-section').style.display = 'block';
                    // Vẽ tuyến đường từ nơi gửi đến nơi nhận
                    if (order.sender_lat && order.sender_lng && order.receiver_lat && order.receiver_lng) {
                        showRouteOnMap(order.sender_lat, order.sender_lng, order.receiver_lat, order.receiver_lng, order.current_status);
                    } else if (order.sender_lat && order.sender_lng && order.receiver_address) {
                        geocodeAndShowRoute(order.sender_lat, order.sender_lng, order.receiver_address, order.current_status);
                    } else if (order.sender_address && order.receiver_address) {
                        geocodeAndShowFullRoute(order.sender_address, order.receiver_address, order.current_status);
                    } else {
                        console.log('No coordinates available, showing default location');
                        // Hiển thị thông báo mặc định
                        const mapDiv = document.getElementById('map');
                        mapDiv.innerHTML = `
                            <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                <h3>Không có thông tin vị trí</h3>
                                <p>Trạng thái: ${getStatusText(order.current_status)}</p>
                                <p>Vị trí hiện tại: ${getCurrentPositionText(order.current_status)}</p>
                                <small>Vui lòng liên hệ hỗ trợ để cập nhật thông tin vị trí</small>
                            </div>
                        `;
                    }
                } else {
                    detailDiv.innerHTML = '<div class="alert alert-error">Không tìm thấy đơn hàng</div>';
                }
            } catch (error) {
                console.error('Search order error:', error);
                detailDiv.innerHTML = '<div class="alert alert-error">Có lỗi xảy ra khi tải dữ liệu</div>';
            }
        }

        // Hàm lấy lat/lng từ tracking item hoặc geocode location
        function getLatLng(item, fallbackLat, fallbackLng, fallbackAddress, callback) {
            if (item.lat && item.lng) {
                callback(item.lat, item.lng);
            } else if (item.location) {
                geocodeAddress(item.location, callback);
            } else if (fallbackLat && fallbackLng) {
                callback(fallbackLat, fallbackLng);
            } else if (fallbackAddress) {
                geocodeAddress(fallbackAddress, callback);
            } else {
                callback(null, null);
            }
        }

        // Geocode địa chỉ, trả về callback(lat, lng)
        function geocodeAddress(address, callback) {
            const API_KEY = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
            const url = `https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(address)}&apiKey=${API_KEY}`;
            
            // Thêm timeout cho geocoding request
            const timeout = setTimeout(() => {
                console.log('Geocoding timeout for address:', address);
                callback(null, null);
            }, 5000); // 5 giây timeout

            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(res => {
                    clearTimeout(timeout);
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.items && data.items.length > 0) {
                        const pos = data.items[0].position;
                        callback(pos.lat, pos.lng);
                    } else {
                        console.log('No geocoding results for address:', address);
                        callback(null, null);
                    }
                })
                .catch(error => {
                    clearTimeout(timeout);
                    console.log('Geocoding error for address:', address, error);
                    callback(null, null);
                });
        }

        // Geocode và hiển thị tuyến đường từ điểm gửi đến địa chỉ nhận
        function geocodeAndShowRoute(senderLat, senderLng, receiverAddress, status) {
            geocodeAddress(receiverAddress, function(receiverLat, receiverLng) {
                if (receiverLat && receiverLng) {
                    showRouteOnMap(senderLat, senderLng, receiverLat, receiverLng, status);
                } else {
                    console.log('Cannot geocode receiver address, showing sender location only');
                    // Hiển thị thông báo lỗi thay vì tạo map riêng
                    const mapDiv = document.getElementById('map');
                    mapDiv.innerHTML = `
                        <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                            <h3>Không thể hiển thị tuyến đường</h3>
                            <p>Trạng thái: ${getStatusText(status)}</p>
                            <p>Vị trí hiện tại: ${getCurrentPositionText(status)}</p>
                            <small>Không thể tìm thấy địa chỉ nhận hàng</small>
                        </div>
                    `;
                }
            });
        }

        // Geocode và hiển thị tuyến đường đầy đủ từ địa chỉ gửi đến địa chỉ nhận
        function geocodeAndShowFullRoute(senderAddress, receiverAddress, status) {
            geocodeAddress(senderAddress, function(senderLat, senderLng) {
                if (senderLat && senderLng) {
                    geocodeAddress(receiverAddress, function(receiverLat, receiverLng) {
                        if (receiverLat && receiverLng) {
                            showRouteOnMap(senderLat, senderLng, receiverLat, receiverLng, status);
                        } else {
                            console.log('Cannot geocode receiver address');
                            // Hiển thị thông báo lỗi thay vì tạo map riêng
                            const mapDiv = document.getElementById('map');
                            mapDiv.innerHTML = `
                                <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                    <h3>Không thể hiển thị tuyến đường</h3>
                                    <p>Trạng thái: ${getStatusText(status)}</p>
                                    <p>Vị trí hiện tại: ${getCurrentPositionText(status)}</p>
                                    <small>Không thể tìm thấy địa chỉ nhận hàng</small>
                                </div>
                            `;
                        }
                    });
                } else {
                    geocodeAddress(receiverAddress, function(receiverLat, receiverLng) {
                        if (receiverLat && receiverLng) {
                            console.log('Cannot geocode sender address');
                            // Hiển thị thông báo lỗi thay vì tạo map riêng
                            const mapDiv = document.getElementById('map');
                            mapDiv.innerHTML = `
                                <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                    <h3>Không thể hiển thị tuyến đường</h3>
                                    <p>Trạng thái: ${getStatusText(status)}</p>
                                    <p>Vị trí hiện tại: ${getCurrentPositionText(status)}</p>
                                    <small>Không thể tìm thấy địa chỉ gửi hàng</small>
                                </div>
                            `;
                        } else {
                            console.log('Cannot geocode both addresses');
                            // Hiển thị thông báo lỗi
                            const mapDiv = document.getElementById('map');
                            mapDiv.innerHTML = `
                                <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                    <h3>Không thể hiển thị bản đồ</h3>
                                    <p>Trạng thái: ${getStatusText(status)}</p>
                                    <p>Vị trí hiện tại: ${getCurrentPositionText(status)}</p>
                                    <small>Không thể tìm thấy địa chỉ gửi và nhận</small>
                                </div>
                            `;
                        }
                    });
                }
            });
        }

        function showRouteOnMap(senderLat, senderLng, receiverLat, receiverLng, status = 'pending', fallbackToMarker = false) {
            console.log('Vẽ map từ:', senderLat, senderLng, 'đến', receiverLat, receiverLng, 'trạng thái:', status);
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            
            try {
                const API_KEY = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
                const platform = new H.service.Platform({ apikey: API_KEY });
                const defaultLayers = platform.createDefaultLayers();
                
                // Tính toán vị trí hiện tại dựa trên trạng thái
                let currentLat, currentLng;
                const senderLatNum = Number(senderLat);
                const senderLngNum = Number(senderLng);
                const receiverLatNum = Number(receiverLat);
                const receiverLngNum = Number(receiverLng);
                
                // Validate coordinates first
                if (isNaN(senderLatNum) || isNaN(senderLngNum) || isNaN(receiverLatNum) || isNaN(receiverLngNum)) {
                    throw new Error('Invalid coordinates provided');
                }
                
                switch(status) {
                    case 'processing':
                        // Vị trí hiện tại ở 1/3 quãng đường từ điểm gửi đến điểm nhận
                        currentLat = senderLatNum + (receiverLatNum - senderLatNum) * 0.33;
                        currentLng = senderLngNum + (receiverLngNum - senderLngNum) * 0.33;
                        break;
                    case 'shipping':
                        // Vị trí hiện tại ở 2/3 quãng đường từ điểm gửi đến điểm nhận
                        currentLat = senderLatNum + (receiverLatNum - senderLatNum) * 0.67;
                        currentLng = senderLngNum + (receiverLngNum - senderLngNum) * 0.67;
                        break;
                    case 'delivered':
                        // Vị trí hiện tại ở điểm nhận
                        currentLat = receiverLatNum;
                        currentLng = receiverLngNum;
                        break;
                    default:
                        // pending, failed, cancelled - vị trí hiện tại ở điểm gửi
                        currentLat = senderLatNum;
                        currentLng = senderLngNum;
                        break;
                }
                
                console.log('Creating map with center:', (senderLatNum + receiverLatNum) / 2, (senderLngNum + receiverLngNum) / 2);
                
                const map = new H.Map(mapDiv, defaultLayers.vector.normal.map, {
                    center: { lat: (senderLatNum + receiverLatNum) / 2, lng: (senderLngNum + receiverLngNum) / 2 },
                    zoom: 7, // Zoom gần hơn để tránh hiển thị nhiều map
                    pixelRatio: window.devicePixelRatio || 1
                });
                
                // Add event listeners
                window.addEventListener('resize', () => map.getViewPort().resize());
                const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
                const ui = H.ui.UI.createDefault(map, defaultLayers);
                
                console.log('Map created successfully, calling API v8...');
                
                // Sử dụng HERE Maps API v8 để tính toán route
                calculateRouteWithAPIv8(senderLat, senderLng, receiverLat, receiverLng, map, currentLat, currentLng, status);
            } catch (error) {
                console.error('Error creating map:', error);
                // Fallback: hiển thị thông báo lỗi
                mapDiv.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                        <h3>Không thể hiển thị bản đồ</h3>
                        <p>Vui lòng thử lại sau hoặc liên hệ hỗ trợ.</p>
                        <small>Lỗi: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Hàm tính toán route sử dụng HERE Maps API v8
        async function calculateRouteWithAPIv8(senderLat, senderLng, receiverLat, receiverLng, map, currentLat, currentLng, status) {
            const API_KEY = '7GUpHwbsEgObqnGg4JG34CJvdbf89IU4iq-SDFe8vmE';
            const url = `https://router.hereapi.com/v8/routes?transportMode=car&origin=${senderLat},${senderLng}&destination=${receiverLat},${receiverLng}&return=summary,polyline&apikey=${API_KEY}`;
            
            try {
                console.log('Calling HERE Maps API v8:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const polyline = route.sections[0].polyline;
                    
                    console.log('Polyline from API:', polyline);
                    
                    // Decode polyline
                    const coordinates = decodePolyline(polyline);
                    console.log('Decoded coordinates:', coordinates.length);
                    
                    if (coordinates.length > 0) {
                        const linestring = new H.geo.LineString();
                        
                        coordinates.forEach(coord => {
                            linestring.pushLatLngAlt(coord.lat, coord.lng);
                        });
                        
                        const routeLine = new H.map.Polyline(linestring, {
                            style: { 
                                strokeColor: '#007bff', 
                                lineWidth: 5 
                            }
                        });
                        map.addObject(routeLine);
                        
                        // Marker điểm gửi
                        const startMarker = new H.map.Marker({ lat: Number(senderLat), lng: Number(senderLng) });
                        map.addObject(startMarker);
                        
                        // Marker điểm nhận
                        const endMarker = new H.map.Marker({ lat: Number(receiverLat), lng: Number(receiverLng) });
                        map.addObject(endMarker);
                        
                        // Marker vị trí hiện tại (dựa trên trạng thái)
                        const currentMarker = new H.map.Marker({ lat: currentLat, lng: currentLng }, {
                            icon: new H.map.Icon('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMloiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0iI2ZmMDAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxwYXRoIGQ9Ik0xMiA4QzEwLjM0IDggOSA5LjM0IDkgMTFDOSAxMi42NiAxMC4zNCAxNCAxMiAxNEMxMy42NiAxNCAxNSAxMi42NiAxNSAxMUMxNSA5LjM0IDEzLjY2IDggMTIgOFoiIGZpbGw9IiNmZjAwMDAiLz4KPC9zdmc+', {
                                size: { w: 24, h: 24 },
                                anchor: { x: 12, y: 12 }
                            })
                        });
                        map.addObject(currentMarker);
                        
                        // Điều chỉnh view để hiển thị 2 địa điểm chính
                        const senderPoint = { lat: Number(senderLat), lng: Number(senderLng) };
                        const receiverPoint = { lat: Number(receiverLat), lng: Number(receiverLng) };
                        
                        // Tạo bounds chỉ bao gồm 2 điểm chính
                        const bounds = new H.geo.Rect(
                            Math.min(senderPoint.lat, receiverPoint.lat),
                            Math.min(senderPoint.lng, receiverPoint.lng),
                            Math.max(senderPoint.lat, receiverPoint.lat),
                            Math.max(senderPoint.lng, receiverPoint.lng)
                        );
                        
                        map.getViewModel().setLookAtData({ 
                            bounds: bounds,
                            padding: { top: 100, right: 100, bottom: 100, left: 100 }
                        });
                        
                        const summary = route.sections[0].summary;
                        const distanceKm = (summary.length / 1000).toFixed(2);
                        const durationMin = Math.round(summary.duration / 60);
                        
                        let infoHtml = `<div class='here-route-info'>` +
                            `<b>Quãng đường:</b> ${distanceKm} km<br>` +
                            `<b>Thời gian dự kiến:</b> ${durationMin} phút<br>` +
                            `<b>Trạng thái hiện tại:</b> ${getStatusText(status)}<br>` +
                            `<b>Vị trí hiện tại:</b> ${getCurrentPositionText(status)}` +
                            `</div>`;
                        document.getElementById('map').insertAdjacentHTML('beforeend', infoHtml);
                        
                        console.log('Route drawn successfully with', coordinates.length, 'points');
                    } else {
                        throw new Error('Invalid polyline coordinates');
                    }
                } else {
                    throw new Error('No routes found in response');
                }
            } catch (error) {
                console.log('Lỗi HERE Maps API v8:', error);
                // Fallback: hiển thị map đơn giản với đường thẳng
                showSimpleMap(map, senderLat, senderLng, receiverLat, receiverLng, currentLat, currentLng, status);
            }
        }

        // Hàm hiển thị map đơn giản với đường thẳng
        function showSimpleMap(map, senderLat, senderLng, receiverLat, receiverLng, currentLat, currentLng, status) {
            try {
                // Validate coordinates
                const senderLatNum = Number(senderLat);
                const senderLngNum = Number(senderLng);
                const receiverLatNum = Number(receiverLat);
                const receiverLngNum = Number(receiverLng);
                
                if (isNaN(senderLatNum) || isNaN(senderLngNum) || isNaN(receiverLatNum) || isNaN(receiverLngNum)) {
                    throw new Error('Invalid coordinates');
                }
                
                console.log('Creating simple map with straight line');
                
                // Vẽ đường thẳng đơn giản
                const linestring = new H.geo.LineString();
                linestring.pushLatLngAlt(senderLatNum, senderLngNum);
                linestring.pushLatLngAlt(receiverLatNum, receiverLngNum);
                
                const routeLine = new H.map.Polyline(linestring, {
                    style: { 
                        strokeColor: '#007bff', 
                        lineWidth: 3,
                        lineDash: [10, 5] // Đường đứt nét để phân biệt
                    }
                });
                map.addObject(routeLine);
                
                // Marker điểm gửi
                const startMarker = new H.map.Marker({ lat: senderLatNum, lng: senderLngNum });
                map.addObject(startMarker);
                
                // Marker điểm nhận
                const endMarker = new H.map.Marker({ lat: receiverLatNum, lng: receiverLngNum });
                map.addObject(endMarker);
                
                // Marker vị trí hiện tại
                const currentMarker = new H.map.Marker({ lat: currentLat, lng: currentLng }, {
                    icon: new H.map.Icon('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMloiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0iI2ZmMDAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxwYXRoIGQ9Ik0xMiA4QzEwLjM0IDggOSA5LjM0IDkgMTFDOSAxMi42NiAxMC4zNCAxNCAxMiAxNEMxMy42NiAxNCAxNSAxMi42NiAxNSAxMUMxNSA5LjM0IDEzLjY2IDggMTIgOFoiIGZpbGw9IiNmZjAwMDAiLz4KPC9zdmc+', {
                        size: { w: 24, h: 24 },
                        anchor: { x: 12, y: 12 }
                })
                });
                map.addObject(currentMarker);
                
                // Điều chỉnh view để hiển thị 2 địa điểm chính
                const senderPoint = { lat: senderLatNum, lng: senderLngNum };
                const receiverPoint = { lat: receiverLatNum, lng: receiverLngNum };
                
                // Tạo bounds chỉ bao gồm 2 điểm chính
                const bounds = new H.geo.Rect(
                    Math.min(senderPoint.lat, receiverPoint.lat),
                    Math.min(senderPoint.lng, receiverPoint.lng),
                    Math.max(senderPoint.lat, receiverPoint.lat),
                    Math.max(senderPoint.lng, receiverPoint.lng)
                );
                
                map.getViewModel().setLookAtData({ 
                    bounds: bounds,
                    padding: { top: 100, right: 100, bottom: 100, left: 100 }
                });
                
                // Tính khoảng cách đơn giản
                const distanceKm = calculateDistance(senderLatNum, senderLngNum, receiverLatNum, receiverLngNum);
                
                let infoHtml = `<div class='here-route-info'>` +
                    `<b>Quãng đường:</b> ${distanceKm.toFixed(2)} km (ước tính)<br>` +
                    `<b>Trạng thái hiện tại:</b> ${getStatusText(status)}<br>` +
                    `<b>Vị trí hiện tại:</b> ${getCurrentPositionText(status)}<br>` +
                    `<small style="color: #666;">⚠️ Hiển thị đường thẳng do lỗi API</small>` +
                    `</div>`;
                document.getElementById('map').insertAdjacentHTML('beforeend', infoHtml);
                
                console.log('Simple map created successfully');
            } catch (error) {
                console.error('Error in showSimpleMap:', error);
                // Final fallback: chỉ hiển thị thông báo
                const mapDiv = document.getElementById('map');
                mapDiv.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px;">
                        <h3>Không thể hiển thị bản đồ</h3>
                        <p>Trạng thái: ${getStatusText(status)}</p>
                        <p>Vị trí hiện tại: ${getCurrentPositionText(status)}</p>
                        <small>Lỗi: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Hàm decode polyline từ HERE Maps API
        function decodePolyline(encoded) {
            if (!encoded || typeof encoded !== 'string') {
                console.log('Invalid polyline string:', encoded);
                return [];
            }
            
            console.log('Decoding polyline:', encoded.substring(0, 50) + '...');
            
            const poly = [];
            let index = 0, len = encoded.length;
            let lat = 0, lng = 0;

            try {
                while (index < len) {
                    let b, shift = 0, result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lat += dlat;

                    shift = 0;
                    result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lng += dlng;

                    const latCoord = lat / 1E5;
                    const lngCoord = lng / 1E5;
                    
                    // Validate coordinates - chỉ chấp nhận coordinates hợp lệ
                    if (latCoord >= -90 && latCoord <= 90 && lngCoord >= -180 && lngCoord <= 180) {
                        poly.push({ lat: latCoord, lng: lngCoord });
                    } else {
                        console.log('Skipping invalid coordinate:', latCoord, lngCoord);
                        // Không thêm vào poly nếu coordinates không hợp lệ
                    }
                }
            } catch (error) {
                console.error('Error decoding polyline:', error);
                return [];
            }
            
            console.log('Decoded polyline coordinates:', poly.length, 'valid points');
            if (poly.length > 0) {
                console.log('First point:', poly[0]);
                console.log('Last point:', poly[poly.length - 1]);
            }
            return poly;
        }

        // Hàm tính khoảng cách đơn giản (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Bán kính Trái Đất (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function logout() {
            api.logout();
        }

        // Helper functions for status
        function getStatusColor(status) {
            const colorMap = {
                'pending': '#ffc107',    // Yellow
                'processing': '#17a2b8',  // Cyan
                'shipping': '#007bff',    // Blue
                'delivered': '#28a745',   // Green
                'failed': '#dc3545',      // Red
                'cancelled': '#6c757d'    // Gray
            };
            return colorMap[status] || '#007bff';
        }

        function getStatusText(status) {
            const textMap = {
                'pending': 'Chờ xử lý',
                'processing': 'Đang xử lý',
                'shipping': 'Đang giao',
                'delivered': 'Đã giao',
                'failed': 'Thất bại',
                'cancelled': 'Đã hủy'
            };
            return textMap[status] || status;
        }

        function getCurrentPositionText(status) {
            const textMap = {
                'pending': 'Điểm gửi hàng',
                'processing': 'Trung tâm xử lý',
                'shipping': 'Đang vận chuyển',
                'delivered': 'Điểm nhận hàng',
                'failed': 'Điểm gửi hàng',
                'cancelled': 'Điểm gửi hàng'
            };
            return textMap[status] || 'Không xác định';
        }
    </script>
</body>
</html> 